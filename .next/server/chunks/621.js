"use strict";exports.id=621,exports.ids=[621],exports.modules={2621:(a,b,c)=>{let d,e,f,g,h,i;c.d(b,{Live2DModel:()=>bq});var j,k,l=c(4684),m=c(1602),n=c(4662),o=c(8986),p=Math.pow,q=(a,b,c)=>new Promise((d,e)=>{var f=a=>{try{h(c.next(a))}catch(a){e(a)}},g=a=>{try{h(c.throw(a))}catch(a){e(a)}},h=a=>a.done?d(a.value):Promise.resolve(a.value).then(f,g);h((c=c.apply(a,b)).next())});class r{constructor(){this._breathParameters=[],this._currentTime=0}static create(){return new r}setParameters(a){this._breathParameters=a}getParameters(){return this._breathParameters}updateParameters(a,b){this._currentTime+=b;let c=2*this._currentTime*3.14159;for(let b=0;b<this._breathParameters.length;++b){let d=this._breathParameters[b];a.addParameterValueById(d.parameterId,d.offset+d.peak*Math.sin(c/d.cycle),d.weight)}}}class s{constructor(a,b,c,d,e){this.parameterId=void 0==a?void 0:a,this.offset=void 0==b?0:b,this.peak=void 0==c?0:c,this.cycle=void 0==d?0:d,this.weight=void 0==e?0:e}}let t=class{static create(a){return new t(a)}setBlinkingInterval(a){this._blinkingIntervalSeconds=a}setBlinkingSetting(a,b,c){this._closingSeconds=a,this._closedSeconds=b,this._openingSeconds=c}setParameterIds(a){this._parameterIds=a}getParameterIds(){return this._parameterIds}updateParameters(a,b){let c;this._userTimeSeconds+=b;let d=0;switch(this._blinkingState){case u.EyeState_Closing:(d=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._closingSeconds)>=1&&(d=1,this._blinkingState=u.EyeState_Closed,this._stateStartTimeSeconds=this._userTimeSeconds),c=1-d;break;case u.EyeState_Closed:(d=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._closedSeconds)>=1&&(this._blinkingState=u.EyeState_Opening,this._stateStartTimeSeconds=this._userTimeSeconds),c=0;break;case u.EyeState_Opening:(d=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._openingSeconds)>=1&&(d=1,this._blinkingState=u.EyeState_Interval,this._nextBlinkingTime=this.determinNextBlinkingTiming()),c=d;break;case u.EyeState_Interval:this._nextBlinkingTime<this._userTimeSeconds&&(this._blinkingState=u.EyeState_Closing,this._stateStartTimeSeconds=this._userTimeSeconds),c=1;break;case u.EyeState_First:default:this._blinkingState=u.EyeState_Interval,this._nextBlinkingTime=this.determinNextBlinkingTiming(),c=1}t.CloseIfZero||(c=-c);for(let b=0;b<this._parameterIds.length;++b)a.setParameterValueById(this._parameterIds[b],c)}constructor(a){var b,c;if(this._blinkingState=u.EyeState_First,this._nextBlinkingTime=0,this._stateStartTimeSeconds=0,this._blinkingIntervalSeconds=4,this._closingSeconds=.1,this._closedSeconds=.05,this._openingSeconds=.15,this._userTimeSeconds=0,this._parameterIds=[],null==a)return;this._parameterIds=null!=(c=null==(b=a.getEyeBlinkParameters())?void 0:b.slice())?c:this._parameterIds}determinNextBlinkingTiming(){let a=Math.random();return this._userTimeSeconds+a*(2*this._blinkingIntervalSeconds-1)}};t.CloseIfZero=!0;var u=(a=>(a[a.EyeState_First=0]="EyeState_First",a[a.EyeState_Interval=1]="EyeState_Interval",a[a.EyeState_Closing=2]="EyeState_Closing",a[a.EyeState_Closed=3]="EyeState_Closed",a[a.EyeState_Opening=4]="EyeState_Opening",a))(u||{});class v{static create(a){let b=new v;"number"==typeof a.FadeInTime&&(b._fadeTimeSeconds=a.FadeInTime,b._fadeTimeSeconds<=0&&(b._fadeTimeSeconds=.5));let c=a.Groups,d=c.length;for(let a=0;a<d;++a){let d=c[a],e=d.length,f=0;for(let a=0;a<e;++a){let c=d[a],e=new w;e.partId=c.Id;let g=c.Link;if(g){let a=g.length;for(let b=0;b<a;++b){let a=new w;a.partId=g[b],e.link.push(a)}}b._partGroups.push(e),++f}b._partGroupCounts.push(f)}return b}updateParameters(a,b){a!=this._lastModel&&this.reset(a),this._lastModel=a,b<0&&(b=0);let c=0;for(let d=0;d<this._partGroupCounts.length;d++){let e=this._partGroupCounts[d];this.doFade(a,b,c,e),c+=e}this.copyPartOpacities(a)}reset(a){let b=0;for(let c=0;c<this._partGroupCounts.length;++c){let d=this._partGroupCounts[c];for(let c=b;c<b+d;++c){this._partGroups[c].initialize(a);let d=this._partGroups[c].partIndex,e=this._partGroups[c].parameterIndex;if(!(d<0)){a.setPartOpacityByIndex(d,+(c==b)),a.setParameterValueByIndex(e,+(c==b));for(let b=0;b<this._partGroups[c].link.length;++b)this._partGroups[c].link[b].initialize(a)}}b+=d}}copyPartOpacities(a){for(let b=0;b<this._partGroups.length;++b){let c=this._partGroups[b];if(0==c.link.length)continue;let d=this._partGroups[b].partIndex,e=a.getPartOpacityByIndex(d);for(let b=0;b<c.link.length;++b){let d=c.link[b].partIndex;d<0||a.setPartOpacityByIndex(d,e)}}}doFade(a,b,c,d){let e=-1,f=1;for(let g=c;g<c+d;++g){let c=this._partGroups[g].partIndex,d=this._partGroups[g].parameterIndex;if(a.getParameterValueByIndex(d)>.001){if(e>=0)break;e=g,(f=a.getPartOpacityByIndex(c)+b/this._fadeTimeSeconds)>1&&(f=1)}}e<0&&(e=0,f=1);for(let b=c;b<c+d;++b){let c=this._partGroups[b].partIndex;if(e==b)a.setPartOpacityByIndex(c,f);else{let b,d=a.getPartOpacityByIndex(c);(1-(b=f<.5?-.5*f/.5+1:(1-f)*.5/.5))*(1-f)>.15&&(b=1-.15/(1-f)),d>b&&(d=b),a.setPartOpacityByIndex(c,d)}}}constructor(){this._fadeTimeSeconds=.5,this._lastModel=void 0,this._partGroups=[],this._partGroupCounts=[]}}class w{constructor(a){this.parameterIndex=0,this.partIndex=0,this.partId="",this.link=[],void 0!=a&&this.assignment(a)}assignment(a){return this.partId=a.partId,this.link=a.link.map(a=>a.clone()),this}initialize(a){this.parameterIndex=a.getParameterIndex(this.partId),this.partIndex=a.getPartIndex(this.partId),a.setParameterValueByIndex(this.parameterIndex,1)}clone(){let a=new w;return a.partId=this.partId,a.parameterIndex=this.parameterIndex,a.partIndex=this.partIndex,a.link=this.link.map(a=>a.clone()),a}}class x{constructor(a,b){this.x=a||0,this.y=b||0}add(a){let b=new x(0,0);return b.x=this.x+a.x,b.y=this.y+a.y,b}substract(a){let b=new x(0,0);return b.x=this.x-a.x,b.y=this.y-a.y,b}multiply(a){let b=new x(0,0);return b.x=this.x*a.x,b.y=this.y*a.y,b}multiplyByScaler(a){return this.multiply(new x(a,a))}division(a){let b=new x(0,0);return b.x=this.x/a.x,b.y=this.y/a.y,b}divisionByScalar(a){return this.division(new x(a,a))}getLength(){return Math.sqrt(this.x*this.x+this.y*this.y)}getDistanceWith(a){return Math.sqrt((this.x-a.x)*(this.x-a.x)+(this.y-a.y)*(this.y-a.y))}dot(a){return this.x*a.x+this.y*a.y}normalize(){let a=Math.pow(this.x*this.x+this.y*this.y,.5);this.x=this.x/a,this.y=this.y/a}isEqual(a){return this.x==a.x&&this.y==a.y}isNotEqual(a){return!this.isEqual(a)}}let y=class{static range(a,b,c){return a<b?a=b:a>c&&(a=c),a}static sin(a){return Math.sin(a)}static cos(a){return Math.cos(a)}static abs(a){return Math.abs(a)}static sqrt(a){return Math.sqrt(a)}static cbrt(a){let b;if(0===a)return a;let c=a,d=c<0;return d&&(c=-c),c===1/0?b=1/0:(b=Math.exp(Math.log(c)/3),b=(c/(b*b)+2*b)/3),d?-b:b}static getEasingSine(a){return a<0?0:a>1?1:.5-.5*this.cos(a*Math.PI)}static max(a,b){return a>b?a:b}static min(a,b){return a>b?b:a}static degreesToRadian(a){return a/180*Math.PI}static radianToDegrees(a){return 180*a/Math.PI}static directionToRadian(a,b){let c=Math.atan2(b.y,b.x)-Math.atan2(a.y,a.x);for(;c<-Math.PI;)c+=2*Math.PI;for(;c>Math.PI;)c-=2*Math.PI;return c}static directionToDegrees(a,b){let c=this.directionToRadian(a,b),d=this.radianToDegrees(c);return b.x-a.x>0&&(d=-d),d}static radianToDirection(a){let b=new x;return b.x=this.sin(a),b.y=this.cos(a),b}static quadraticEquation(a,b,c){return this.abs(a)<y.Epsilon?this.abs(b)<y.Epsilon?-c:-c/b:-(b+this.sqrt(b*b-4*a*c))/(2*a)}static cardanoAlgorithmForBezier(a,b,c,d){if(this.sqrt(a)<y.Epsilon)return this.range(this.quadraticEquation(b,c,d),0,1);let e=b/a,f=c/a,g=(3*f-e*e)/3,h=g/3,i=(2*e*e*e-9*e*f+d/a*27)/27,j=i/2,k=j*j+h*h*h;if(k<0){let a=-g/3,b=this.sqrt(a*a*a),c=Math.acos(this.range(-i/(2*b),-1,1)),d=2*this.cbrt(b),f=d*this.cos(c/3)-e/3;if(.51>this.abs(f-.5))return this.range(f,0,1);let h=d*this.cos((c+2*Math.PI)/3)-e/3;if(.51>this.abs(h-.5))return this.range(h,0,1);let j=d*this.cos((c+4*Math.PI)/3)-e/3;return this.range(j,0,1)}if(0==k){let a,b=2*(a=j<0?this.cbrt(-j):-this.cbrt(j))-e/3;return .51>this.abs(b-.5)?this.range(b,0,1):this.range(-a-e/3,0,1)}let l=this.sqrt(k),m=this.cbrt(l-j),n=this.cbrt(l+j);return this.range(m-n-e/3,0,1)}constructor(){}};y.Epsilon=1e-5;class z{constructor(){this._tr=new Float32Array(16),this.loadIdentity()}static multiply(a,b,c){let d=new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);for(let c=0;c<4;++c)for(let e=0;e<4;++e)for(let f=0;f<4;++f)d[e+4*c]+=a[f+4*c]*b[e+4*f];for(let a=0;a<16;++a)c[a]=d[a]}loadIdentity(){let a=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.setMatrix(a)}setMatrix(a){for(let b=0;b<16;++b)this._tr[b]=a[b]}getArray(){return this._tr}getScaleX(){return this._tr[0]}getScaleY(){return this._tr[5]}getTranslateX(){return this._tr[12]}getTranslateY(){return this._tr[13]}transformX(a){return this._tr[0]*a+this._tr[12]}transformY(a){return this._tr[5]*a+this._tr[13]}invertTransformX(a){return(a-this._tr[12])/this._tr[0]}invertTransformY(a){return(a-this._tr[13])/this._tr[5]}translateRelative(a,b){let c=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,a,b,0,1]);z.multiply(c,this._tr,this._tr)}translate(a,b){this._tr[12]=a,this._tr[13]=b}translateX(a){this._tr[12]=a}translateY(a){this._tr[13]=a}scaleRelative(a,b){let c=new Float32Array([a,0,0,0,0,b,0,0,0,0,1,0,0,0,0,1]);z.multiply(c,this._tr,this._tr)}scale(a,b){this._tr[0]=a,this._tr[5]=b}multiplyByMatrix(a){z.multiply(a.getArray(),this._tr,this._tr)}clone(){let a=new z;for(let b=0;b<this._tr.length;b++)a._tr[b]=this._tr[b];return a}}class A{initialize(a){this._model=a}drawModel(){null!=this.getModel()&&this.doDrawModel()}setMvpMatrix(a){this._mvpMatrix4x4.setMatrix(a.getArray())}getMvpMatrix(){return this._mvpMatrix4x4}setModelColor(a,b,c,d){a<0?a=0:a>1&&(a=1),b<0?b=0:b>1&&(b=1),c<0?c=0:c>1&&(c=1),d<0?d=0:d>1&&(d=1),this._modelColor.R=a,this._modelColor.G=b,this._modelColor.B=c,this._modelColor.A=d}getModelColor(){return Object.assign({},this._modelColor)}setIsPremultipliedAlpha(a){this._isPremultipliedAlpha=a}isPremultipliedAlpha(){return this._isPremultipliedAlpha}setIsCulling(a){this._isCulling=a}isCulling(){return this._isCulling}setAnisotropy(a){this._anisortopy=a}getAnisotropy(){return this._anisortopy}getModel(){return this._model}constructor(){this._isCulling=!1,this._isPremultipliedAlpha=!1,this._anisortopy=0,this._modelColor=new C,this._mvpMatrix4x4=new z,this._mvpMatrix4x4.loadIdentity()}}var B=(a=>(a[a.CubismBlendMode_Normal=0]="CubismBlendMode_Normal",a[a.CubismBlendMode_Additive=1]="CubismBlendMode_Additive",a[a.CubismBlendMode_Multiplicative=2]="CubismBlendMode_Multiplicative",a))(B||{});class C{constructor(){this.R=1,this.G=1,this.B=1,this.A=1}}let D=!1,E=!1,F={vertexOffset:0,vertexStep:2};class G{static startUp(a){if(D)return K("CubismFramework.startUp() is already done."),D;if(Live2DCubismCore._isStarted)return D=!0,!0;Live2DCubismCore._isStarted=!0,(i=a)&&Live2DCubismCore.Logging.csmSetLogFunction(i.logFunction),D=!0;{let a=Live2DCubismCore.Version.csmGetVersion(),b=(0xff000000&a)>>24,c=(0xff0000&a)>>16,d=65535&a;K("Live2D Cubism Core version: {0}.{1}.{2} ({3})",("00"+b).slice(-2),("00"+c).slice(-2),("0000"+d).slice(-4),a)}return K("CubismFramework.startUp() is complete."),D}static cleanUp(){D=!1,E=!1,i=void 0}static initialize(){return D?E?void L("CubismFramework.initialize() skipped, already initialized."):void(E=!0,K("CubismFramework.initialize() is complete.")):void L("CubismFramework is not started.")}static dispose(){return D?E?void(A.staticRelease(),E=!1,K("CubismFramework.dispose() is complete.")):void L("CubismFramework.dispose() skipped, not initialized."):void L("CubismFramework is not started.")}static isStarted(){return D}static isInitialized(){return E}static coreLogFunction(a){Live2DCubismCore.Logging.csmGetLogFunction()&&Live2DCubismCore.Logging.csmGetLogFunction()(a)}static getLoggingLevel(){return null!=i?i.loggingLevel:H.LogLevel_Off}constructor(){}}var H=(a=>(a[a.LogLevel_Verbose=0]="LogLevel_Verbose",a[a.LogLevel_Debug=1]="LogLevel_Debug",a[a.LogLevel_Info=2]="LogLevel_Info",a[a.LogLevel_Warning=3]="LogLevel_Warning",a[a.LogLevel_Error=4]="LogLevel_Error",a[a.LogLevel_Off=5]="LogLevel_Off",a))(H||{});let I=()=>{};function J(a,...b){N.print(H.LogLevel_Debug,"[CSM][D]"+a+"\n",b)}function K(a,...b){N.print(H.LogLevel_Info,"[CSM][I]"+a+"\n",b)}function L(a,...b){N.print(H.LogLevel_Warning,"[CSM][W]"+a+"\n",b)}function M(a,...b){N.print(H.LogLevel_Error,"[CSM][E]"+a+"\n",b)}class N{static print(a,b,c){if(a<G.getLoggingLevel())return;let d=G.coreLogFunction;d&&d(b.replace(/{(\d+)}/g,(a,b)=>c[b]))}static dumpBytes(a,b,c){for(let d=0;d<c;d++)d%16==0&&d>0?this.print(a,"\n"):d%8==0&&d>0&&this.print(a,"  "),this.print(a,"{0} ",[255&b[d]]);this.print(a,"\n")}constructor(){}}class O{update(){this._model.update(),this._model.drawables.resetDynamicFlags()}getCanvasWidth(){return null==this._model?0:this._model.canvasinfo.CanvasWidth/this._model.canvasinfo.PixelsPerUnit}getCanvasHeight(){return null==this._model?0:this._model.canvasinfo.CanvasHeight/this._model.canvasinfo.PixelsPerUnit}saveParameters(){let a=this._model.parameters.count,b=this._savedParameters.length;for(let c=0;c<a;++c)c<b?this._savedParameters[c]=this._parameterValues[c]:this._savedParameters.push(this._parameterValues[c])}getModel(){return this._model}getPartIndex(a){let b,c=this._model.parts.count;for(b=0;b<c;++b)if(a==this._partIds[b])return b;return a in this._notExistPartId?this._notExistPartId[a]:(b=c+this._notExistPartId.length,this._notExistPartId[a]=b,this._notExistPartOpacities[b]=0,b)}getPartCount(){return this._model.parts.count}setPartOpacityByIndex(a,b){if(a in this._notExistPartOpacities){this._notExistPartOpacities[a]=b;return}I(0<=a&&a<this.getPartCount()),this._partOpacities[a]=b}setPartOpacityById(a,b){let c=this.getPartIndex(a);c<0||this.setPartOpacityByIndex(c,b)}getPartOpacityByIndex(a){return a in this._notExistPartOpacities?this._notExistPartOpacities[a]:(I(0<=a&&a<this.getPartCount()),this._partOpacities[a])}getPartOpacityById(a){let b=this.getPartIndex(a);return b<0?0:this.getPartOpacityByIndex(b)}getParameterIndex(a){let b,c=this._model.parameters.count;for(b=0;b<c;++b)if(a==this._parameterIds[b])return b;return a in this._notExistParameterId?this._notExistParameterId[a]:(b=this._model.parameters.count+Object.keys(this._notExistParameterId).length,this._notExistParameterId[a]=b,this._notExistParameterValues[b]=0,b)}getParameterCount(){return this._model.parameters.count}getParameterMaximumValue(a){return this._model.parameters.maximumValues[a]}getParameterMinimumValue(a){return this._model.parameters.minimumValues[a]}getParameterDefaultValue(a){return this._model.parameters.defaultValues[a]}getParameterValueByIndex(a){return a in this._notExistParameterValues?this._notExistParameterValues[a]:(I(0<=a&&a<this.getParameterCount()),this._parameterValues[a])}getParameterValueById(a){let b=this.getParameterIndex(a);return this.getParameterValueByIndex(b)}setParameterValueByIndex(a,b,c=1){if(a in this._notExistParameterValues){this._notExistParameterValues[a]=1==c?b:this._notExistParameterValues[a]*(1-c)+b*c;return}I(0<=a&&a<this.getParameterCount()),this._model.parameters.maximumValues[a]<b&&(b=this._model.parameters.maximumValues[a]),this._model.parameters.minimumValues[a]>b&&(b=this._model.parameters.minimumValues[a]),this._parameterValues[a]=1==c?b:this._parameterValues[a]=this._parameterValues[a]*(1-c)+b*c}setParameterValueById(a,b,c=1){let d=this.getParameterIndex(a);this.setParameterValueByIndex(d,b,c)}addParameterValueByIndex(a,b,c=1){this.setParameterValueByIndex(a,this.getParameterValueByIndex(a)+b*c)}addParameterValueById(a,b,c=1){let d=this.getParameterIndex(a);this.addParameterValueByIndex(d,b,c)}multiplyParameterValueById(a,b,c=1){let d=this.getParameterIndex(a);this.multiplyParameterValueByIndex(d,b,c)}multiplyParameterValueByIndex(a,b,c=1){this.setParameterValueByIndex(a,this.getParameterValueByIndex(a)*(1+(b-1)*c))}getDrawableIds(){return this._drawableIds.slice()}getDrawableIndex(a){let b=this._model.drawables.count;for(let c=0;c<b;++c)if(this._drawableIds[c]==a)return c;return -1}getDrawableCount(){return this._model.drawables.count}getDrawableId(a){return this._model.drawables.ids[a]}getDrawableRenderOrders(){return this._model.drawables.renderOrders}getDrawableTextureIndices(a){return this._model.drawables.textureIndices[a]}getDrawableDynamicFlagVertexPositionsDidChange(a){let b=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasVertexPositionsDidChangeBit(b[a])}getDrawableVertexIndexCount(a){return this._model.drawables.indexCounts[a]}getDrawableVertexCount(a){return this._model.drawables.vertexCounts[a]}getDrawableVertices(a){return this.getDrawableVertexPositions(a)}getDrawableVertexIndices(a){return this._model.drawables.indices[a]}getDrawableVertexPositions(a){return this._model.drawables.vertexPositions[a]}getDrawableVertexUvs(a){return this._model.drawables.vertexUvs[a]}getDrawableOpacity(a){return this._model.drawables.opacities[a]}getDrawableCulling(a){let b=this._model.drawables.constantFlags;return!Live2DCubismCore.Utils.hasIsDoubleSidedBit(b[a])}getDrawableBlendMode(a){let b=this._model.drawables.constantFlags;return Live2DCubismCore.Utils.hasBlendAdditiveBit(b[a])?B.CubismBlendMode_Additive:Live2DCubismCore.Utils.hasBlendMultiplicativeBit(b[a])?B.CubismBlendMode_Multiplicative:B.CubismBlendMode_Normal}getDrawableInvertedMaskBit(a){let b=this._model.drawables.constantFlags;return Live2DCubismCore.Utils.hasIsInvertedMaskBit(b[a])}getDrawableMasks(){return this._model.drawables.masks}getDrawableMaskCounts(){return this._model.drawables.maskCounts}isUsingMasking(){for(let a=0;a<this._model.drawables.count;++a)if(!(this._model.drawables.maskCounts[a]<=0))return!0;return!1}getDrawableDynamicFlagIsVisible(a){let b=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasIsVisibleBit(b[a])}getDrawableDynamicFlagVisibilityDidChange(a){let b=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasVisibilityDidChangeBit(b[a])}getDrawableDynamicFlagOpacityDidChange(a){let b=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasOpacityDidChangeBit(b[a])}getDrawableDynamicFlagRenderOrderDidChange(a){let b=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasRenderOrderDidChangeBit(b[a])}loadParameters(){let a=this._model.parameters.count,b=this._savedParameters.length;a>b&&(a=b);for(let b=0;b<a;++b)this._parameterValues[b]=this._savedParameters[b]}initialize(){this._parameterValues=this._model.parameters.values,this._partOpacities=this._model.parts.opacities,this._parameterMaximumValues=this._model.parameters.maximumValues,this._parameterMinimumValues=this._model.parameters.minimumValues;{let a=this._model.parameters.ids,b=this._model.parameters.count;for(let c=0;c<b;++c)this._parameterIds.push(a[c])}{let a=this._model.parts.ids,b=this._model.parts.count;for(let c=0;c<b;++c)this._partIds.push(a[c])}{let a=this._model.drawables.ids,b=this._model.drawables.count;for(let c=0;c<b;++c)this._drawableIds.push(a[c])}}constructor(a){this._model=a,this._savedParameters=[],this._parameterIds=[],this._drawableIds=[],this._partIds=[],this._notExistPartId={},this._notExistParameterId={},this._notExistParameterValues={},this._notExistPartOpacities={},this.initialize()}release(){this._model.release(),this._model=void 0}}class P{static create(a){let b=Live2DCubismCore.Moc.fromArrayBuffer(a);if(b)return new P(b);throw Error("Unknown error")}createModel(){let a,b=Live2DCubismCore.Model.fromMoc(this._moc);if(b)return a=new O(b),++this._modelCount,a;throw Error("Unknown error")}deleteModel(a){null!=a&&--this._modelCount}constructor(a){this._moc=a,this._modelCount=0}release(){this._moc._release(),this._moc=void 0}}class Q{constructor(){this._fadeInSeconds=-1,this._fadeOutSeconds=-1,this._weight=1,this._offsetSeconds=0,this._firedEventValues=[]}release(){this._weight=0}updateParameters(a,b,c){if(!b.isAvailable()||b.isFinished())return;if(!b.isStarted()){b.setIsStarted(!0),b.setStartTime(c-this._offsetSeconds),b.setFadeInStartTime(c);let a=this.getDuration();0>b.getEndTime()&&b.setEndTime(a<=0?-1:b.getStartTime()+a)}let d=this._weight;d=d*(0==this._fadeInSeconds?1:y.getEasingSine((c-b.getFadeInStartTime())/this._fadeInSeconds))*(0==this._fadeOutSeconds||0>b.getEndTime()?1:y.getEasingSine((b.getEndTime()-c)/this._fadeOutSeconds)),b.setState(c,d),this.doUpdateParameters(a,c,d,b),b.getEndTime()>0&&b.getEndTime()<c&&b.setIsFinished(!0)}setFadeInTime(a){this._fadeInSeconds=a}setFadeOutTime(a){this._fadeOutSeconds=a}getFadeOutTime(){return this._fadeOutSeconds}getFadeInTime(){return this._fadeInSeconds}setWeight(a){this._weight=a}getWeight(){return this._weight}getDuration(){return -1}getLoopDuration(){return -1}setOffsetTime(a){this._offsetSeconds=a}getFiredEvent(a,b){return this._firedEventValues}setFinishedMotionHandler(a){this._onFinishedMotion=a}getFinishedMotionHandler(){return this._onFinishedMotion}}class R extends Q{constructor(){super(),this._parameters=[]}static create(a){let b=new R,c=a.FadeInTime,d=a.FadeOutTime;b.setFadeInTime(void 0!==c?c:1),b.setFadeOutTime(void 0!==d?d:1);let e=a.Parameters||[];for(let a=0;a<e.length;++a){let c,d=e[a],f=d.Id,g=d.Value;switch(d.Blend){case"Multiply":c=S.ExpressionBlendType_Multiply;break;case"Overwrite":c=S.ExpressionBlendType_Overwrite;break;default:c=S.ExpressionBlendType_Add}let h={parameterId:f,blendType:c,value:g};b._parameters.push(h)}return b}doUpdateParameters(a,b,c,d){for(let b=0;b<this._parameters.length;++b){let d=this._parameters[b];switch(d.blendType){case S.ExpressionBlendType_Add:a.addParameterValueById(d.parameterId,d.value,c);break;case S.ExpressionBlendType_Multiply:a.multiplyParameterValueById(d.parameterId,d.value,c);break;case S.ExpressionBlendType_Overwrite:a.setParameterValueById(d.parameterId,d.value,c)}}}}var S=(a=>(a[a.ExpressionBlendType_Add=0]="ExpressionBlendType_Add",a[a.ExpressionBlendType_Multiply=1]="ExpressionBlendType_Multiply",a[a.ExpressionBlendType_Overwrite=2]="ExpressionBlendType_Overwrite",a))(S||{});(a=>{a.supportMoreMaskDivisions=!0,a.setOpacityFromMotion=!1})(j||(j={}));var T=(a=>(a[a.CubismMotionCurveTarget_Model=0]="CubismMotionCurveTarget_Model",a[a.CubismMotionCurveTarget_Parameter=1]="CubismMotionCurveTarget_Parameter",a[a.CubismMotionCurveTarget_PartOpacity=2]="CubismMotionCurveTarget_PartOpacity",a))(T||{}),U=(a=>(a[a.CubismMotionSegmentType_Linear=0]="CubismMotionSegmentType_Linear",a[a.CubismMotionSegmentType_Bezier=1]="CubismMotionSegmentType_Bezier",a[a.CubismMotionSegmentType_Stepped=2]="CubismMotionSegmentType_Stepped",a[a.CubismMotionSegmentType_InverseStepped=3]="CubismMotionSegmentType_InverseStepped",a))(U||{});class V{constructor(a=0,b=0){this.time=a,this.value=b}}class W{constructor(){this.basePointIndex=0,this.segmentType=0}}class X{constructor(){this.id="",this.type=0,this.segmentCount=0,this.baseSegmentIndex=0,this.fadeInTime=0,this.fadeOutTime=0}}class Y{constructor(){this.fireTime=0,this.value=""}}class Z{constructor(){this.duration=0,this.loop=!1,this.curveCount=0,this.eventCount=0,this.fps=0,this.curves=[],this.segments=[],this.points=[],this.events=[]}}class ${constructor(a){this._json=a}release(){this._json=void 0}getMotionDuration(){return this._json.Meta.Duration}isMotionLoop(){return this._json.Meta.Loop||!1}getEvaluationOptionFlag(a){return _.EvaluationOptionFlag_AreBeziersRistricted==a&&!!this._json.Meta.AreBeziersRestricted}getMotionCurveCount(){return this._json.Meta.CurveCount}getMotionFps(){return this._json.Meta.Fps}getMotionTotalSegmentCount(){return this._json.Meta.TotalSegmentCount}getMotionTotalPointCount(){return this._json.Meta.TotalPointCount}getMotionFadeInTime(){return this._json.Meta.FadeInTime}getMotionFadeOutTime(){return this._json.Meta.FadeOutTime}getMotionCurveTarget(a){return this._json.Curves[a].Target}getMotionCurveId(a){return this._json.Curves[a].Id}getMotionCurveFadeInTime(a){return this._json.Curves[a].FadeInTime}getMotionCurveFadeOutTime(a){return this._json.Curves[a].FadeOutTime}getMotionCurveSegmentCount(a){return this._json.Curves[a].Segments.length}getMotionCurveSegment(a,b){return this._json.Curves[a].Segments[b]}getEventCount(){return this._json.Meta.UserDataCount||0}getTotalEventValueSize(){return this._json.Meta.TotalUserDataSize}getEventTime(a){return this._json.UserData[a].Time}getEventValue(a){return this._json.UserData[a].Value}}var _=(a=>(a[a.EvaluationOptionFlag_AreBeziersRistricted=0]="EvaluationOptionFlag_AreBeziersRistricted",a))(_||{});function aa(a,b,c){let d=new V;return d.time=a.time+(b.time-a.time)*c,d.value=a.value+(b.value-a.value)*c,d}function ab(a,b){let c=(b-a[0].time)/(a[1].time-a[0].time);return c<0&&(c=0),a[0].value+(a[1].value-a[0].value)*c}function ac(a,b){let c=(b-a[0].time)/(a[3].time-a[0].time);c<0&&(c=0);let d=aa(a[0],a[1],c),e=aa(a[1],a[2],c),f=aa(a[2],a[3],c),g=aa(d,e,c),h=aa(e,f,c);return aa(g,h,c).value}function ad(a,b){let c=a[0].time,d=a[3].time,e=a[1].time,f=a[2].time,g=y.cardanoAlgorithmForBezier(d-3*f+3*e-c,3*f-6*e+3*c,3*e-3*c,c-b),h=aa(a[0],a[1],g),i=aa(a[1],a[2],g),j=aa(a[2],a[3],g),k=aa(h,i,g),l=aa(i,j,g);return aa(k,l,g).value}function ae(a,b){return a[0].value}function af(a,b){return a[1].value}function ag(a,b,c){let d=a.curves[b],e=-1,f=d.baseSegmentIndex+d.segmentCount,g=0;for(let b=d.baseSegmentIndex;b<f;++b)if(g=a.segments[b].basePointIndex+(a.segments[b].segmentType==U.CubismMotionSegmentType_Bezier?3:1),a.points[g].time>c){e=b;break}if(-1==e)return a.points[g].value;let h=a.segments[e];return h.evaluate(a.points.slice(h.basePointIndex),c)}class ah extends Q{constructor(){super(),this._eyeBlinkParameterIds=[],this._lipSyncParameterIds=[],this._sourceFrameRate=30,this._loopDurationSeconds=-1,this._isLoop=!1,this._isLoopFadeIn=!0,this._lastWeight=0}static create(a,b){let c=new ah;return c.parse(a),c._sourceFrameRate=c._motionData.fps,c._loopDurationSeconds=c._motionData.duration,c._onFinishedMotion=b,c}doUpdateParameters(a,b,c,d){let e,f,g;null==this._modelCurveIdEyeBlink&&(this._modelCurveIdEyeBlink="EyeBlink"),null==this._modelCurveIdLipSync&&(this._modelCurveIdLipSync="LipSync");let h=b-d.getStartTime();h<0&&(h=0);let i=Number.MAX_VALUE,k=Number.MAX_VALUE,l=0,m=0;this._eyeBlinkParameterIds.length>64&&J("too many eye blink targets : {0}",this._eyeBlinkParameterIds.length),this._lipSyncParameterIds.length>64&&J("too many lip sync targets : {0}",this._lipSyncParameterIds.length);let n=this._fadeInSeconds<=0?1:y.getEasingSine((b-d.getFadeInStartTime())/this._fadeInSeconds),o=this._fadeOutSeconds<=0||0>d.getEndTime()?1:y.getEasingSine((d.getEndTime()-b)/this._fadeOutSeconds),p=h;if(this._isLoop)for(;p>this._motionData.duration;)p-=this._motionData.duration;let q=this._motionData.curves;for(f=0;f<this._motionData.curveCount&&q[f].type==T.CubismMotionCurveTarget_Model;++f)e=ag(this._motionData,f,p),q[f].id==this._modelCurveIdEyeBlink?k=e:q[f].id==this._modelCurveIdLipSync&&(i=e);for(;f<this._motionData.curveCount&&q[f].type==T.CubismMotionCurveTarget_Parameter;++f){let h;if(-1==(g=a.getParameterIndex(q[f].id)))continue;let j=a.getParameterValueByIndex(g);if(e=ag(this._motionData,f,p),k!=Number.MAX_VALUE){for(let a=0;a<this._eyeBlinkParameterIds.length&&a<64;++a)if(this._eyeBlinkParameterIds[a]==q[f].id){e*=k,m|=1<<a;break}}if(i!=Number.MAX_VALUE){for(let a=0;a<this._lipSyncParameterIds.length&&a<64;++a)if(this._lipSyncParameterIds[a]==q[f].id){e+=i,l|=1<<a;break}}if(q[f].fadeInTime<0&&q[f].fadeOutTime<0)h=j+(e-j)*c;else{let a,c;a=q[f].fadeInTime<0?n:0==q[f].fadeInTime?1:y.getEasingSine((b-d.getFadeInStartTime())/q[f].fadeInTime),c=q[f].fadeOutTime<0?o:0==q[f].fadeOutTime||0>d.getEndTime()?1:y.getEasingSine((d.getEndTime()-b)/q[f].fadeOutTime),h=j+(e-j)*(this._weight*a*c)}a.setParameterValueByIndex(g,h,1)}if(k!=Number.MAX_VALUE)for(let b=0;b<this._eyeBlinkParameterIds.length&&b<64;++b){let d=a.getParameterValueById(this._eyeBlinkParameterIds[b]);if(m>>b&1)continue;let e=d+(k-d)*c;a.setParameterValueById(this._eyeBlinkParameterIds[b],e)}if(i!=Number.MAX_VALUE)for(let b=0;b<this._lipSyncParameterIds.length&&b<64;++b){let d=a.getParameterValueById(this._lipSyncParameterIds[b]);if(l>>b&1)continue;let e=d+(i-d)*c;a.setParameterValueById(this._lipSyncParameterIds[b],e)}for(;f<this._motionData.curveCount&&q[f].type==T.CubismMotionCurveTarget_PartOpacity;++f)if(e=ag(this._motionData,f,p),j.setOpacityFromMotion)a.setPartOpacityById(q[f].id,e);else{if(-1==(g=a.getParameterIndex(q[f].id)))continue;a.setParameterValueByIndex(g,e)}h>=this._motionData.duration&&(this._isLoop?(d.setStartTime(b),this._isLoopFadeIn&&d.setFadeInStartTime(b)):(this._onFinishedMotion&&this._onFinishedMotion(this),d.setIsFinished(!0))),this._lastWeight=c}setIsLoop(a){this._isLoop=a}isLoop(){return this._isLoop}setIsLoopFadeIn(a){this._isLoopFadeIn=a}isLoopFadeIn(){return this._isLoopFadeIn}getDuration(){return this._isLoop?-1:this._loopDurationSeconds}getLoopDuration(){return this._loopDurationSeconds}setParameterFadeInTime(a,b){let c=this._motionData.curves;for(let d=0;d<this._motionData.curveCount;++d)if(a==c[d].id){c[d].fadeInTime=b;return}}setParameterFadeOutTime(a,b){let c=this._motionData.curves;for(let d=0;d<this._motionData.curveCount;++d)if(a==c[d].id){c[d].fadeOutTime=b;return}}getParameterFadeInTime(a){let b=this._motionData.curves;for(let c=0;c<this._motionData.curveCount;++c)if(a==b[c].id)return b[c].fadeInTime;return -1}getParameterFadeOutTime(a){let b=this._motionData.curves;for(let c=0;c<this._motionData.curveCount;++c)if(a==b[c].id)return b[c].fadeOutTime;return -1}setEffectIds(a,b){this._eyeBlinkParameterIds=a,this._lipSyncParameterIds=b}release(){this._motionData=void 0}parse(a){this._motionData=new Z;let b=new $(a);this._motionData.duration=b.getMotionDuration(),this._motionData.loop=b.isMotionLoop(),this._motionData.curveCount=b.getMotionCurveCount(),this._motionData.fps=b.getMotionFps(),this._motionData.eventCount=b.getEventCount();let c=b.getEvaluationOptionFlag(_.EvaluationOptionFlag_AreBeziersRistricted),d=b.getMotionFadeInTime(),e=b.getMotionFadeOutTime();void 0!==d?this._fadeInSeconds=d<0?1:d:this._fadeInSeconds=1,void 0!==e?this._fadeOutSeconds=e<0?1:e:this._fadeOutSeconds=1,this._motionData.curves=Array.from({length:this._motionData.curveCount}).map(()=>new X),this._motionData.segments=Array.from({length:b.getMotionTotalSegmentCount()}).map(()=>new W),this._motionData.events=Array.from({length:this._motionData.eventCount}).map(()=>new Y),this._motionData.points=[];let f=0,g=0;for(let a=0;a<this._motionData.curveCount;++a){let d=this._motionData.curves[a];switch(b.getMotionCurveTarget(a)){case"Model":d.type=T.CubismMotionCurveTarget_Model;break;case"Parameter":d.type=T.CubismMotionCurveTarget_Parameter;break;case"PartOpacity":d.type=T.CubismMotionCurveTarget_PartOpacity;break;default:L('Warning : Unable to get segment type from Curve! The number of "CurveCount" may be incorrect!')}d.id=b.getMotionCurveId(a),d.baseSegmentIndex=g;let e=b.getMotionCurveFadeInTime(a),h=b.getMotionCurveFadeOutTime(a);d.fadeInTime=void 0!==e?e:-1,d.fadeOutTime=void 0!==h?h:-1;for(let e=0;e<b.getMotionCurveSegmentCount(a);){switch(0==e?(this._motionData.segments[g].basePointIndex=f,this._motionData.points[f]=new V(b.getMotionCurveSegment(a,e),b.getMotionCurveSegment(a,e+1)),f+=1,e+=2):this._motionData.segments[g].basePointIndex=f-1,b.getMotionCurveSegment(a,e)){case U.CubismMotionSegmentType_Linear:this._motionData.segments[g].segmentType=U.CubismMotionSegmentType_Linear,this._motionData.segments[g].evaluate=ab,this._motionData.points[f]=new V(b.getMotionCurveSegment(a,e+1),b.getMotionCurveSegment(a,e+2)),f+=1,e+=3;break;case U.CubismMotionSegmentType_Bezier:this._motionData.segments[g].segmentType=U.CubismMotionSegmentType_Bezier,c?this._motionData.segments[g].evaluate=ac:this._motionData.segments[g].evaluate=ad,this._motionData.points[f]=new V(b.getMotionCurveSegment(a,e+1),b.getMotionCurveSegment(a,e+2)),this._motionData.points[f+1]=new V(b.getMotionCurveSegment(a,e+3),b.getMotionCurveSegment(a,e+4)),this._motionData.points[f+2]=new V(b.getMotionCurveSegment(a,e+5),b.getMotionCurveSegment(a,e+6)),f+=3,e+=7;break;case U.CubismMotionSegmentType_Stepped:this._motionData.segments[g].segmentType=U.CubismMotionSegmentType_Stepped,this._motionData.segments[g].evaluate=ae,this._motionData.points[f]=new V(b.getMotionCurveSegment(a,e+1),b.getMotionCurveSegment(a,e+2)),f+=1,e+=3;break;case U.CubismMotionSegmentType_InverseStepped:this._motionData.segments[g].segmentType=U.CubismMotionSegmentType_InverseStepped,this._motionData.segments[g].evaluate=af,this._motionData.points[f]=new V(b.getMotionCurveSegment(a,e+1),b.getMotionCurveSegment(a,e+2)),f+=1,e+=3}++d.segmentCount,++g}this._motionData.curves.push(d)}for(let a=0;a<b.getEventCount();++a)this._motionData.events[a].fireTime=b.getEventTime(a),this._motionData.events[a].value=b.getEventValue(a);b.release()}getFiredEvent(a,b){this._firedEventValues.length=0;for(let c=0;c<this._motionData.eventCount;++c)this._motionData.events[c].fireTime>a&&this._motionData.events[c].fireTime<=b&&this._firedEventValues.push(this._motionData.events[c].value);return this._firedEventValues}}class ai{constructor(){this._autoDelete=!1,this._available=!0,this._finished=!1,this._started=!1,this._startTimeSeconds=-1,this._fadeInStartTimeSeconds=0,this._endTimeSeconds=-1,this._stateTimeSeconds=0,this._stateWeight=0,this._lastEventCheckSeconds=0,this._motionQueueEntryHandle=this,this._fadeOutSeconds=0,this._isTriggeredFadeOut=!1}release(){this._autoDelete&&this._motion&&this._motion.release()}setFadeOut(a){this._fadeOutSeconds=a,this._isTriggeredFadeOut=!0}startFadeOut(a,b){let c=b+a;this._isTriggeredFadeOut=!0,(this._endTimeSeconds<0||c<this._endTimeSeconds)&&(this._endTimeSeconds=c)}isFinished(){return this._finished}isStarted(){return this._started}getStartTime(){return this._startTimeSeconds}getFadeInStartTime(){return this._fadeInStartTimeSeconds}getEndTime(){return this._endTimeSeconds}setStartTime(a){this._startTimeSeconds=a}setFadeInStartTime(a){this._fadeInStartTimeSeconds=a}setEndTime(a){this._endTimeSeconds=a}setIsFinished(a){this._finished=a}setIsStarted(a){this._started=a}isAvailable(){return this._available}setIsAvailable(a){this._available=a}setState(a,b){this._stateTimeSeconds=a,this._stateWeight=b}getStateTime(){return this._stateTimeSeconds}getStateWeight(){return this._stateWeight}getLastCheckEventSeconds(){return this._lastEventCheckSeconds}setLastCheckEventSeconds(a){this._lastEventCheckSeconds=a}isTriggeredFadeOut(){return this._isTriggeredFadeOut}getFadeOutSeconds(){return this._fadeOutSeconds}}class aj{constructor(){this._userTimeSeconds=0,this._eventCustomData=null,this._motions=[]}release(){for(let a=0;a<this._motions.length;++a)this._motions[a]&&this._motions[a].release();this._motions=void 0}startMotion(a,b,c){let d;if(null==a)return ak;for(let a=0;a<this._motions.length;++a)null!=(d=this._motions[a])&&d.setFadeOut(d._motion.getFadeOutTime());return(d=new ai)._autoDelete=b,d._motion=a,this._motions.push(d),d._motionQueueEntryHandle}isFinished(){let a=0;for(;a<this._motions.length;){let b=this._motions[a];if(null==b){this._motions.splice(a,1);continue}if(null==b._motion){b.release(),this._motions.splice(a,1);continue}if(!b.isFinished())return!1;a++}return!0}isFinishedByHandle(a){for(let b=0;b<this._motions.length;b++){let c=this._motions[b];if(null!=c&&c._motionQueueEntryHandle==a&&!c.isFinished())return!1}return!0}stopAllMotions(){for(let a=0;a<this._motions.length;a++){let b=this._motions[a];null!=b&&b.release()}this._motions=[]}getCubismMotionQueueEntry(a){return this._motions.find(b=>null!=b&&b._motionQueueEntryHandle==a)}setEventCallback(a,b=null){this._eventCallBack=a,this._eventCustomData=b}doUpdateMotion(a,b){let c=!1,d=0;for(;d<this._motions.length;){let e=this._motions[d];if(null==e){this._motions.splice(d,1);continue}let f=e._motion;if(null==f){e.release(),this._motions.splice(d,1);continue}f.updateParameters(a,e,b),c=!0;let g=f.getFiredEvent(e.getLastCheckEventSeconds()-e.getStartTime(),b-e.getStartTime());for(let a=0;a<g.length;++a)this._eventCallBack(this,g[a],this._eventCustomData);e.setLastCheckEventSeconds(b),e.isFinished()?(e.release(),this._motions.splice(d,1)):(e.isTriggeredFadeOut()&&e.startFadeOut(e.getFadeOutSeconds(),b),d++)}return c}}let ak=-1;var al=(a=>(a[a.CubismPhysicsTargetType_Parameter=0]="CubismPhysicsTargetType_Parameter",a))(al||{}),am=(a=>(a[a.CubismPhysicsSource_X=0]="CubismPhysicsSource_X",a[a.CubismPhysicsSource_Y=1]="CubismPhysicsSource_Y",a[a.CubismPhysicsSource_Angle=2]="CubismPhysicsSource_Angle",a))(am||{});class an{constructor(){this.initialPosition=new x(0,0),this.position=new x(0,0),this.lastPosition=new x(0,0),this.lastGravity=new x(0,0),this.force=new x(0,0),this.velocity=new x(0,0)}}class ao{constructor(){this.normalizationPosition={},this.normalizationAngle={}}}class ap{constructor(){this.source={}}}class aq{constructor(){this.destination={},this.translationScale=new x(0,0)}}class ar{constructor(){this.settings=[],this.inputs=[],this.outputs=[],this.particles=[],this.gravity=new x(0,0),this.wind=new x(0,0)}}class as{constructor(a){this._json=a}release(){this._json=void 0}getGravity(){let a=new x(0,0);return a.x=this._json.Meta.EffectiveForces.Gravity.X,a.y=this._json.Meta.EffectiveForces.Gravity.Y,a}getWind(){let a=new x(0,0);return a.x=this._json.Meta.EffectiveForces.Wind.X,a.y=this._json.Meta.EffectiveForces.Wind.Y,a}getSubRigCount(){return this._json.Meta.PhysicsSettingCount}getTotalInputCount(){return this._json.Meta.TotalInputCount}getTotalOutputCount(){return this._json.Meta.TotalOutputCount}getVertexCount(){return this._json.Meta.VertexCount}getNormalizationPositionMinimumValue(a){return this._json.PhysicsSettings[a].Normalization.Position.Minimum}getNormalizationPositionMaximumValue(a){return this._json.PhysicsSettings[a].Normalization.Position.Maximum}getNormalizationPositionDefaultValue(a){return this._json.PhysicsSettings[a].Normalization.Position.Default}getNormalizationAngleMinimumValue(a){return this._json.PhysicsSettings[a].Normalization.Angle.Minimum}getNormalizationAngleMaximumValue(a){return this._json.PhysicsSettings[a].Normalization.Angle.Maximum}getNormalizationAngleDefaultValue(a){return this._json.PhysicsSettings[a].Normalization.Angle.Default}getInputCount(a){return this._json.PhysicsSettings[a].Input.length}getInputWeight(a,b){return this._json.PhysicsSettings[a].Input[b].Weight}getInputReflect(a,b){return this._json.PhysicsSettings[a].Input[b].Reflect}getInputType(a,b){return this._json.PhysicsSettings[a].Input[b].Type}getInputSourceId(a,b){return this._json.PhysicsSettings[a].Input[b].Source.Id}getOutputCount(a){return this._json.PhysicsSettings[a].Output.length}getOutputVertexIndex(a,b){return this._json.PhysicsSettings[a].Output[b].VertexIndex}getOutputAngleScale(a,b){return this._json.PhysicsSettings[a].Output[b].Scale}getOutputWeight(a,b){return this._json.PhysicsSettings[a].Output[b].Weight}getOutputDestinationId(a,b){return this._json.PhysicsSettings[a].Output[b].Destination.Id}getOutputType(a,b){return this._json.PhysicsSettings[a].Output[b].Type}getOutputReflect(a,b){return this._json.PhysicsSettings[a].Output[b].Reflect}getParticleCount(a){return this._json.PhysicsSettings[a].Vertices.length}getParticleMobility(a,b){return this._json.PhysicsSettings[a].Vertices[b].Mobility}getParticleDelay(a,b){return this._json.PhysicsSettings[a].Vertices[b].Delay}getParticleAcceleration(a,b){return this._json.PhysicsSettings[a].Vertices[b].Acceleration}getParticleRadius(a,b){return this._json.PhysicsSettings[a].Vertices[b].Radius}getParticlePosition(a,b){let c=new x(0,0);return c.x=this._json.PhysicsSettings[a].Vertices[b].Position.X,c.y=this._json.PhysicsSettings[a].Vertices[b].Position.Y,c}}let at="Angle";class au{static create(a){let b=new au;return b.parse(a),b._physicsRig.gravity.y=0,b}evaluate(a,b){let c,d,e,f,g,h,i,j,k,l,m,n,o=new x;k=a.getModel().parameters.values,l=a.getModel().parameters.maximumValues,m=a.getModel().parameters.minimumValues,n=a.getModel().parameters.defaultValues;for(let p=0;p<this._physicsRig.subRigCount;++p){c={angle:0},o.x=0,o.y=0,g=this._physicsRig.settings[p],h=this._physicsRig.inputs.slice(g.baseInputIndex),i=this._physicsRig.outputs.slice(g.baseOutputIndex),j=this._physicsRig.particles.slice(g.baseParticleIndex);for(let b=0;b<g.inputCount;++b)d=h[b].weight/100,-1==h[b].sourceParameterIndex&&(h[b].sourceParameterIndex=a.getParameterIndex(h[b].source.id)),h[b].getNormalizedParameterValue(o,c,k[h[b].sourceParameterIndex],m[h[b].sourceParameterIndex],l[h[b].sourceParameterIndex],n[h[b].sourceParameterIndex],g.normalizationPosition,g.normalizationAngle,h[b].reflect,d);e=y.degreesToRadian(-c.angle),o.x=o.x*y.cos(e)-o.y*y.sin(e),o.y=o.x*y.sin(e)+o.y*y.cos(e),function(a,b,c,d,e,f,g,h){let i,j,k,l,m=new x(0,0),n=new x(0,0),o=new x(0,0),p=new x(0,0);a[0].position=new x(c.x,c.y),i=y.degreesToRadian(d),(l=y.radianToDirection(i)).normalize();for(let c=1;c<b;++c)a[c].force=l.multiplyByScaler(a[c].acceleration).add(e),a[c].lastPosition=new x(a[c].position.x,a[c].position.y),j=a[c].delay*g*30,m=a[c].position.substract(a[c-1].position),k=y.directionToRadian(a[c].lastGravity,l)/5,m.x=y.cos(k)*m.x-m.y*y.sin(k),m.y=y.sin(k)*m.x+m.y*y.cos(k),a[c].position=a[c-1].position.add(m),n=a[c].velocity.multiplyByScaler(j),o=a[c].force.multiplyByScaler(j).multiplyByScaler(j),a[c].position=a[c].position.add(n).add(o),(p=a[c].position.substract(a[c-1].position)).normalize(),a[c].position=a[c-1].position.add(p.multiplyByScaler(a[c].radius)),y.abs(a[c].position.x)<f&&(a[c].position.x=0),0!=j&&(a[c].velocity=a[c].position.substract(a[c].lastPosition),a[c].velocity=a[c].velocity.divisionByScalar(j),a[c].velocity=a[c].velocity.multiplyByScaler(a[c].mobility)),a[c].force=new x(0,0),a[c].lastGravity=new x(l.x,l.y)}(j,g.particleCount,o,c.angle,this._options.wind,.001*g.normalizationPosition.maximum,b,5);for(let b=0;b<g.outputCount;++b){let c=i[b].vertexIndex;if(c<1||c>=g.particleCount)break;-1==i[b].destinationParameterIndex&&(i[b].destinationParameterIndex=a.getParameterIndex(i[b].destination.id));let d=new x;d.x=j[c].position.x-j[c-1].position.x,d.y=j[c].position.y-j[c-1].position.y,f=i[b].getValue(d,j,c,i[b].reflect,this._options.gravity);let e=i[b].destinationParameterIndex,h=!Float32Array.prototype.slice&&"subarray"in Float32Array.prototype?JSON.parse(JSON.stringify(k.subarray(e))):k.slice(e);!function(a,b,c,d,e){let f,g;(f=d*e.getScale(e.translationScale,e.angleScale))<b?(f<e.valueBelowMinimum&&(e.valueBelowMinimum=f),f=b):f>c&&(f>e.valueExceededMaximum&&(e.valueExceededMaximum=f),f=c),(g=e.weight/100)>=1||(f=a[0]*(1-g)+f*g),a[0]=f}(h,m[e],l[e],f,i[b]);for(let a=e,b=0;a<k.length;a++,b++)k[a]=h[b]}}}setOptions(a){this._options=a}getOption(){return this._options}constructor(){this._options=new av,this._options.gravity.y=-1,this._options.gravity.x=0,this._options.wind.x=0,this._options.wind.y=0}release(){this._physicsRig=void 0}parse(a){this._physicsRig=new ar;let b=new as(a);this._physicsRig.gravity=b.getGravity(),this._physicsRig.wind=b.getWind(),this._physicsRig.subRigCount=b.getSubRigCount();let c=0,d=0,e=0;for(let a=0;a<this._physicsRig.subRigCount;++a){let f=new ao;f.normalizationPosition.minimum=b.getNormalizationPositionMinimumValue(a),f.normalizationPosition.maximum=b.getNormalizationPositionMaximumValue(a),f.normalizationPosition.defalut=b.getNormalizationPositionDefaultValue(a),f.normalizationAngle.minimum=b.getNormalizationAngleMinimumValue(a),f.normalizationAngle.maximum=b.getNormalizationAngleMaximumValue(a),f.normalizationAngle.defalut=b.getNormalizationAngleDefaultValue(a),f.inputCount=b.getInputCount(a),f.baseInputIndex=c,c+=f.inputCount;for(let c=0;c<f.inputCount;++c){let d=new ap;switch(d.sourceParameterIndex=-1,d.weight=b.getInputWeight(a,c),d.reflect=b.getInputReflect(a,c),b.getInputType(a,c)){case"X":d.type=am.CubismPhysicsSource_X,d.getNormalizedParameterValue=aw;break;case"Y":d.type=am.CubismPhysicsSource_Y,d.getNormalizedParameterValue=ax;break;case at:d.type=am.CubismPhysicsSource_Angle,d.getNormalizedParameterValue=ay}d.source.targetType=al.CubismPhysicsTargetType_Parameter,d.source.id=b.getInputSourceId(a,c),this._physicsRig.inputs.push(d)}f.outputCount=b.getOutputCount(a),f.baseOutputIndex=d,d+=f.outputCount;for(let c=0;c<f.outputCount;++c){let d=new aq;switch(d.destinationParameterIndex=-1,d.vertexIndex=b.getOutputVertexIndex(a,c),d.angleScale=b.getOutputAngleScale(a,c),d.weight=b.getOutputWeight(a,c),d.destination.targetType=al.CubismPhysicsTargetType_Parameter,d.destination.id=b.getOutputDestinationId(a,c),b.getOutputType(a,c)){case"X":d.type=am.CubismPhysicsSource_X,d.getValue=az,d.getScale=aC;break;case"Y":d.type=am.CubismPhysicsSource_Y,d.getValue=aA,d.getScale=aD;break;case at:d.type=am.CubismPhysicsSource_Angle,d.getValue=aB,d.getScale=aE}d.reflect=b.getOutputReflect(a,c),this._physicsRig.outputs.push(d)}f.particleCount=b.getParticleCount(a),f.baseParticleIndex=e,e+=f.particleCount;for(let c=0;c<f.particleCount;++c){let d=new an;d.mobility=b.getParticleMobility(a,c),d.delay=b.getParticleDelay(a,c),d.acceleration=b.getParticleAcceleration(a,c),d.radius=b.getParticleRadius(a,c),d.position=b.getParticlePosition(a,c),this._physicsRig.particles.push(d)}this._physicsRig.settings.push(f)}this.initialize(),b.release()}initialize(){let a,b,c;for(let d=0;d<this._physicsRig.subRigCount;++d){b=this._physicsRig.settings[d],(a=this._physicsRig.particles.slice(b.baseParticleIndex))[0].initialPosition=new x(0,0),a[0].lastPosition=new x(a[0].initialPosition.x,a[0].initialPosition.y),a[0].lastGravity=new x(0,-1),a[0].lastGravity.y*=-1,a[0].velocity=new x(0,0),a[0].force=new x(0,0);for(let d=1;d<b.particleCount;++d)(c=new x(0,0)).y=a[d].radius,a[d].initialPosition=new x(a[d-1].initialPosition.x+c.x,a[d-1].initialPosition.y+c.y),a[d].position=new x(a[d].initialPosition.x,a[d].initialPosition.y),a[d].lastPosition=new x(a[d].initialPosition.x,a[d].initialPosition.y),a[d].lastGravity=new x(0,-1),a[d].lastGravity.y*=-1,a[d].velocity=new x(0,0),a[d].force=new x(0,0)}}}class av{constructor(){this.gravity=new x(0,0),this.wind=new x(0,0)}}function aw(a,b,c,d,e,f,g,h,i,j){a.x+=aF(c,d,e,f,g.minimum,g.maximum,g.defalut,i)*j}function ax(a,b,c,d,e,f,g,h,i,j){a.y+=aF(c,d,e,f,g.minimum,g.maximum,g.defalut,i)*j}function ay(a,b,c,d,e,f,g,h,i,j){b.angle+=aF(c,d,e,f,h.minimum,h.maximum,h.defalut,i)*j}function az(a,b,c,d,e){let f=a.x;return d&&(f*=-1),f}function aA(a,b,c,d,e){let f=a.y;return d&&(f*=-1),f}function aB(a,b,c,d,e){let f;return e=c>=2?b[c-1].position.substract(b[c-2].position):e.multiplyByScaler(-1),f=y.directionToRadian(e,a),d&&(f*=-1),f}function aC(a,b){return a.x}function aD(a,b){return a.y}function aE(a,b){return b}function aF(a,b,c,d,e,f,g,h){let i=0,j=y.max(c,b);j<a&&(a=j);let k=y.min(c,b);k>a&&(a=k);let l=y.min(e,f),m=y.max(e,f),n=Math.min(k,j)+Math.abs(Math.max(k,j)-Math.min(k,j))/2,o=a-n;switch(Math.sign(o)){case 1:{let a=j-n;0!=a&&(i=(m-g)/a*o+g);break}case -1:{let a=k-n;0!=a&&(i=(l-g)/a*o+g);break}case 0:i=g}return h?i:-1*i}class aG{constructor(a=0,b=0,c=0,d=0){this.x=a,this.y=b,this.width=c,this.height=d}getCenterX(){return this.x+.5*this.width}getCenterY(){return this.y+.5*this.height}getRight(){return this.x+this.width}getBottom(){return this.y+this.height}setRect(a){this.x=a.x,this.y=a.y,this.width=a.width,this.height=a.height}expand(a,b){this.x-=a,this.y-=b,this.width+=2*a,this.height+=2*b}}class aH{getChannelFlagAsColor(a){return this._channelColors[a]}getMaskRenderTexture(){let a=0;if(this._maskTexture&&0!=this._maskTexture.texture&&(this._maskTexture.frameNo=this._currentFrameNo,a=this._maskTexture.texture),0==a){let b=this._clippingMaskBufferSize;this._colorBuffer=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this._colorBuffer),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,b,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.bindTexture(this.gl.TEXTURE_2D,null),a=this.gl.createFramebuffer(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,a),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this._colorBuffer,0),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,f),this._maskTexture=new aI(this._currentFrameNo,a)}return a}setGL(a){this.gl=a}calcClippedDrawTotalBounds(a,b){let c=Number.MAX_VALUE,d=Number.MAX_VALUE,e=5e-324,f=5e-324,g=b._clippedDrawableIndexList.length;for(let h=0;h<g;h++){let g=b._clippedDrawableIndexList[h],i=a.getDrawableVertexCount(g),j=a.getDrawableVertices(g),k=Number.MAX_VALUE,l=Number.MAX_VALUE,m=5e-324,n=5e-324,o=i*F.vertexStep;for(let a=F.vertexOffset;a<o;a+=F.vertexStep){let b=j[a],c=j[a+1];b<k&&(k=b),b>m&&(m=b),c<l&&(l=c),c>n&&(n=c)}if(k!=Number.MAX_VALUE)if(k<c&&(c=k),l<d&&(d=l),m>e&&(e=m),n>f&&(f=n),c==Number.MAX_VALUE)b._allClippedDrawRect.x=0,b._allClippedDrawRect.y=0,b._allClippedDrawRect.width=0,b._allClippedDrawRect.height=0,b._isUsing=!1;else{b._isUsing=!0;let a=e-c,g=f-d;b._allClippedDrawRect.x=c,b._allClippedDrawRect.y=d,b._allClippedDrawRect.width=a,b._allClippedDrawRect.height=g}}}constructor(){this._maskRenderTexture=null,this._colorBuffer=null,this._currentFrameNo=0,this._clippingMaskBufferSize=256,this._clippingContextListForMask=[],this._clippingContextListForDraw=[],this._channelColors=[],this._tmpBoundsOnModel=new aG,this._tmpMatrix=new z,this._tmpMatrixForMask=new z,this._tmpMatrixForDraw=new z;let a=new C;a.R=1,a.G=0,a.B=0,a.A=0,this._channelColors.push(a),(a=new C).R=0,a.G=1,a.B=0,a.A=0,this._channelColors.push(a),(a=new C).R=0,a.G=0,a.B=1,a.A=0,this._channelColors.push(a),(a=new C).R=0,a.G=0,a.B=0,a.A=1,this._channelColors.push(a)}release(){var a,b,c;for(let b=0;b<this._clippingContextListForMask.length;b++)this._clippingContextListForMask[b]&&(null==(a=this._clippingContextListForMask[b])||a.release());this._clippingContextListForMask=void 0,this._clippingContextListForDraw=void 0,this._maskTexture&&(null==(b=this.gl)||b.deleteFramebuffer(this._maskTexture.texture),this._maskTexture=void 0),this._channelColors=void 0,null==(c=this.gl)||c.deleteTexture(this._colorBuffer),this._colorBuffer=null}initialize(a,b,c,d){for(let a=0;a<b;a++){if(d[a]<=0){this._clippingContextListForDraw.push(null);continue}let b=this.findSameClip(c[a],d[a]);null==b&&(b=new aJ(this,c[a],d[a]),this._clippingContextListForMask.push(b)),b.addClippedDrawable(a),this._clippingContextListForDraw.push(b)}}setupClippingContext(a,b){this._currentFrameNo++;let c=0;for(let b=0;b<this._clippingContextListForMask.length;b++){let d=this._clippingContextListForMask[b];this.calcClippedDrawTotalBounds(a,d),d._isUsing&&c++}if(c>0){this.gl.viewport(0,0,this._clippingMaskBufferSize,this._clippingMaskBufferSize),this._maskRenderTexture=this.getMaskRenderTexture(),b.getMvpMatrix(),b.preDraw(),this.setupLayoutBounds(c),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._maskRenderTexture),this.gl.clearColor(1,1,1,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT);for(let c=0;c<this._clippingContextListForMask.length;c++){let d=this._clippingContextListForMask[c],e=d._allClippedDrawRect,f=d._layoutBounds;this._tmpBoundsOnModel.setRect(e),this._tmpBoundsOnModel.expand(.05*e.width,.05*e.height);let g=f.width/this._tmpBoundsOnModel.width,h=f.height/this._tmpBoundsOnModel.height;this._tmpMatrix.loadIdentity(),this._tmpMatrix.translateRelative(-1,-1),this._tmpMatrix.scaleRelative(2,2),this._tmpMatrix.translateRelative(f.x,f.y),this._tmpMatrix.scaleRelative(g,h),this._tmpMatrix.translateRelative(-this._tmpBoundsOnModel.x,-this._tmpBoundsOnModel.y),this._tmpMatrixForMask.setMatrix(this._tmpMatrix.getArray()),this._tmpMatrix.loadIdentity(),this._tmpMatrix.translateRelative(f.x,f.y),this._tmpMatrix.scaleRelative(g,h),this._tmpMatrix.translateRelative(-this._tmpBoundsOnModel.x,-this._tmpBoundsOnModel.y),this._tmpMatrixForDraw.setMatrix(this._tmpMatrix.getArray()),d._matrixForMask.setMatrix(this._tmpMatrixForMask.getArray()),d._matrixForDraw.setMatrix(this._tmpMatrixForDraw.getArray());let i=d._clippingIdCount;for(let c=0;c<i;c++){let e=d._clippingIdList[c];a.getDrawableDynamicFlagVertexPositionsDidChange(e)&&(b.setIsCulling(!1!=a.getDrawableCulling(e)),b.setClippingContextBufferForMask(d),b.drawMesh(a.getDrawableTextureIndices(e),a.getDrawableVertexIndexCount(e),a.getDrawableVertexCount(e),a.getDrawableVertexIndices(e),a.getDrawableVertices(e),a.getDrawableVertexUvs(e),a.getDrawableOpacity(e),B.CubismBlendMode_Normal,!1))}}this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,f),b.setClippingContextBufferForMask(null),this.gl.viewport(e[0],e[1],e[2],e[3])}}findSameClip(a,b){for(let c=0;c<this._clippingContextListForMask.length;c++){let d=this._clippingContextListForMask[c],e=d._clippingIdCount;if(e!=b)continue;let f=0;for(let b=0;b<e;b++){let c=d._clippingIdList[b];for(let b=0;b<e;b++)if(a[b]==c){f++;break}}if(f==e)return d}return null}setupLayoutBounds(a){let b=a/4,c=a%4;b=~~b,c=~~c;let d=0;for(let a=0;a<4;a++){let e=b+ +(a<c);if(0==e);else if(1==e){let b=this._clippingContextListForMask[d++];b._layoutChannelNo=a,b._layoutBounds.x=0,b._layoutBounds.y=0,b._layoutBounds.width=1,b._layoutBounds.height=1}else if(2==e)for(let b=0;b<e;b++){let c=b%2;c=~~c;let e=this._clippingContextListForMask[d++];e._layoutChannelNo=a,e._layoutBounds.x=.5*c,e._layoutBounds.y=0,e._layoutBounds.width=.5,e._layoutBounds.height=1}else if(e<=4)for(let b=0;b<e;b++){let c=b%2,e=b/2;c=~~c,e=~~e;let f=this._clippingContextListForMask[d++];f._layoutChannelNo=a,f._layoutBounds.x=.5*c,f._layoutBounds.y=.5*e,f._layoutBounds.width=.5,f._layoutBounds.height=.5}else if(e<=9)for(let b=0;b<e;b++){let c=b%3,e=b/3;c=~~c,e=~~e;let f=this._clippingContextListForMask[d++];f._layoutChannelNo=a,f._layoutBounds.x=c/3,f._layoutBounds.y=e/3,f._layoutBounds.width=1/3,f._layoutBounds.height=1/3}else if(j.supportMoreMaskDivisions&&e<=16)for(let b=0;b<e;b++){let c=b%4,e=b/4;c=~~c,e=~~e;let f=this._clippingContextListForMask[d++];f._layoutChannelNo=a,f._layoutBounds.x=c/4,f._layoutBounds.y=e/4,f._layoutBounds.width=1/4,f._layoutBounds.height=1/4}else M("not supported mask count : {0}",e)}}getColorBuffer(){return this._colorBuffer}getClippingContextListForDraw(){return this._clippingContextListForDraw}setClippingMaskBufferSize(a){this._clippingMaskBufferSize=a}getClippingMaskBufferSize(){return this._clippingMaskBufferSize}}class aI{constructor(a,b){this.frameNo=a,this.texture=b}}class aJ{constructor(a,b,c){this._isUsing=!1,this._owner=a,this._clippingIdList=b,this._clippingIdCount=c,this._allClippedDrawRect=new aG,this._layoutBounds=new aG,this._clippedDrawableIndexList=[],this._matrixForMask=new z,this._matrixForDraw=new z}release(){this._layoutBounds=void 0,this._allClippedDrawRect=void 0,this._clippedDrawableIndexList=void 0}addClippedDrawable(a){this._clippedDrawableIndexList.push(a)}getClippingManager(){return this._owner}setGl(a){this._owner.setGL(a)}}class aK{static getInstance(){return null==d&&(d=new aK),d}static deleteInstance(){d&&(d.release(),d=void 0)}constructor(){this._shaderSets=[]}release(){this.releaseShaderProgram()}setupShaderProgram(a,b,c,d,e,f,g,h,i,j,k,l,m){let n,o,p,q;k||M("NoPremultipliedAlpha is not allowed"),0==this._shaderSets.length&&this.generateShaders();let r=a.getClippingContextBufferForMask();if(null!=r){let a=this._shaderSets[aL.ShaderNames_SetupMask];this.gl.useProgram(a.shaderProgram),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,b),this.gl.uniform1i(a.samplerTexture0Location,0),null==g.vertex&&(g.vertex=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,g.vertex),this.gl.bufferData(this.gl.ARRAY_BUFFER,d,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(a.attributePositionLocation),this.gl.vertexAttribPointer(a.attributePositionLocation,2,this.gl.FLOAT,!1,0,0),null==g.uv&&(g.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,g.uv),this.gl.bufferData(this.gl.ARRAY_BUFFER,f,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(a.attributeTexCoordLocation),this.gl.vertexAttribPointer(a.attributeTexCoordLocation,2,this.gl.FLOAT,!1,0,0);let c=r._layoutChannelNo,e=r.getClippingManager().getChannelFlagAsColor(c);this.gl.uniform4f(a.uniformChannelFlagLocation,e.R,e.G,e.B,e.A),this.gl.uniformMatrix4fv(a.uniformClipMatrixLocation,!1,r._matrixForMask.getArray());let h=r._layoutBounds;this.gl.uniform4f(a.uniformBaseColorLocation,2*h.x-1,2*h.y-1,2*h.getRight()-1,2*h.getBottom()-1),n=this.gl.ZERO,o=this.gl.ONE_MINUS_SRC_COLOR,p=this.gl.ZERO,q=this.gl.ONE_MINUS_SRC_ALPHA}else{let c,e=a.getClippingContextBufferForDraw(),h=null!=e?m?2:1:0;switch(i){case B.CubismBlendMode_Normal:default:c=this._shaderSets[aL.ShaderNames_NormalPremultipliedAlpha+h],n=this.gl.ONE,o=this.gl.ONE_MINUS_SRC_ALPHA,p=this.gl.ONE,q=this.gl.ONE_MINUS_SRC_ALPHA;break;case B.CubismBlendMode_Additive:c=this._shaderSets[aL.ShaderNames_AddPremultipliedAlpha+h],n=this.gl.ONE,o=this.gl.ONE,p=this.gl.ZERO,q=this.gl.ONE;break;case B.CubismBlendMode_Multiplicative:c=this._shaderSets[aL.ShaderNames_MultPremultipliedAlpha+h],n=this.gl.DST_COLOR,o=this.gl.ONE_MINUS_SRC_ALPHA,p=this.gl.ZERO,q=this.gl.ONE}if(this.gl.useProgram(c.shaderProgram),null==g.vertex&&(g.vertex=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,g.vertex),this.gl.bufferData(this.gl.ARRAY_BUFFER,d,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(c.attributePositionLocation),this.gl.vertexAttribPointer(c.attributePositionLocation,2,this.gl.FLOAT,!1,0,0),null==g.uv&&(g.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,g.uv),this.gl.bufferData(this.gl.ARRAY_BUFFER,f,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(c.attributeTexCoordLocation),this.gl.vertexAttribPointer(c.attributeTexCoordLocation,2,this.gl.FLOAT,!1,0,0),null!=e){this.gl.activeTexture(this.gl.TEXTURE1);let a=e.getClippingManager().getColorBuffer();this.gl.bindTexture(this.gl.TEXTURE_2D,a),this.gl.uniform1i(c.samplerTexture1Location,1),this.gl.uniformMatrix4fv(c.uniformClipMatrixLocation,!1,e._matrixForDraw.getArray());let b=e._layoutChannelNo,d=e.getClippingManager().getChannelFlagAsColor(b);this.gl.uniform4f(c.uniformChannelFlagLocation,d.R,d.G,d.B,d.A)}this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,b),this.gl.uniform1i(c.samplerTexture0Location,0),this.gl.uniformMatrix4fv(c.uniformMatrixLocation,!1,l.getArray()),this.gl.uniform4f(c.uniformBaseColorLocation,j.R,j.G,j.B,j.A)}null==g.index&&(g.index=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,g.index),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,e,this.gl.DYNAMIC_DRAW),this.gl.blendFuncSeparate(n,o,p,q)}releaseShaderProgram(){for(let a=0;a<this._shaderSets.length;a++)this.gl.deleteProgram(this._shaderSets[a].shaderProgram),this._shaderSets[a].shaderProgram=0;this._shaderSets=[]}generateShaders(){for(let a=0;a<10;a++)this._shaderSets.push({});this._shaderSets[0].shaderProgram=this.loadShaderProgram(aM,aN),this._shaderSets[1].shaderProgram=this.loadShaderProgram(aO,aQ),this._shaderSets[2].shaderProgram=this.loadShaderProgram(aP,aR),this._shaderSets[3].shaderProgram=this.loadShaderProgram(aP,aS),this._shaderSets[4].shaderProgram=this._shaderSets[1].shaderProgram,this._shaderSets[5].shaderProgram=this._shaderSets[2].shaderProgram,this._shaderSets[6].shaderProgram=this._shaderSets[3].shaderProgram,this._shaderSets[7].shaderProgram=this._shaderSets[1].shaderProgram,this._shaderSets[8].shaderProgram=this._shaderSets[2].shaderProgram,this._shaderSets[9].shaderProgram=this._shaderSets[3].shaderProgram,this._shaderSets[0].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[0].shaderProgram,"a_position"),this._shaderSets[0].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[0].shaderProgram,"a_texCoord"),this._shaderSets[0].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[0].shaderProgram,"s_texture0"),this._shaderSets[0].uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets[0].shaderProgram,"u_clipMatrix"),this._shaderSets[0].uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets[0].shaderProgram,"u_channelFlag"),this._shaderSets[0].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[0].shaderProgram,"u_baseColor"),this._shaderSets[1].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[1].shaderProgram,"a_position"),this._shaderSets[1].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[1].shaderProgram,"a_texCoord"),this._shaderSets[1].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[1].shaderProgram,"s_texture0"),this._shaderSets[1].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[1].shaderProgram,"u_matrix"),this._shaderSets[1].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[1].shaderProgram,"u_baseColor"),this._shaderSets[2].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[2].shaderProgram,"a_position"),this._shaderSets[2].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[2].shaderProgram,"a_texCoord"),this._shaderSets[2].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[2].shaderProgram,"s_texture0"),this._shaderSets[2].samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets[2].shaderProgram,"s_texture1"),this._shaderSets[2].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[2].shaderProgram,"u_matrix"),this._shaderSets[2].uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets[2].shaderProgram,"u_clipMatrix"),this._shaderSets[2].uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets[2].shaderProgram,"u_channelFlag"),this._shaderSets[2].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[2].shaderProgram,"u_baseColor"),this._shaderSets[3].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[3].shaderProgram,"a_position"),this._shaderSets[3].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[3].shaderProgram,"a_texCoord"),this._shaderSets[3].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[3].shaderProgram,"s_texture0"),this._shaderSets[3].samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets[3].shaderProgram,"s_texture1"),this._shaderSets[3].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[3].shaderProgram,"u_matrix"),this._shaderSets[3].uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets[3].shaderProgram,"u_clipMatrix"),this._shaderSets[3].uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets[3].shaderProgram,"u_channelFlag"),this._shaderSets[3].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[3].shaderProgram,"u_baseColor"),this._shaderSets[4].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[4].shaderProgram,"a_position"),this._shaderSets[4].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[4].shaderProgram,"a_texCoord"),this._shaderSets[4].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[4].shaderProgram,"s_texture0"),this._shaderSets[4].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[4].shaderProgram,"u_matrix"),this._shaderSets[4].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[4].shaderProgram,"u_baseColor"),this._shaderSets[5].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[5].shaderProgram,"a_position"),this._shaderSets[5].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[5].shaderProgram,"a_texCoord"),this._shaderSets[5].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[5].shaderProgram,"s_texture0"),this._shaderSets[5].samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets[5].shaderProgram,"s_texture1"),this._shaderSets[5].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[5].shaderProgram,"u_matrix"),this._shaderSets[5].uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets[5].shaderProgram,"u_clipMatrix"),this._shaderSets[5].uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets[5].shaderProgram,"u_channelFlag"),this._shaderSets[5].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[5].shaderProgram,"u_baseColor"),this._shaderSets[6].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[6].shaderProgram,"a_position"),this._shaderSets[6].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[6].shaderProgram,"a_texCoord"),this._shaderSets[6].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[6].shaderProgram,"s_texture0"),this._shaderSets[6].samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets[6].shaderProgram,"s_texture1"),this._shaderSets[6].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[6].shaderProgram,"u_matrix"),this._shaderSets[6].uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets[6].shaderProgram,"u_clipMatrix"),this._shaderSets[6].uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets[6].shaderProgram,"u_channelFlag"),this._shaderSets[6].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[6].shaderProgram,"u_baseColor"),this._shaderSets[7].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[7].shaderProgram,"a_position"),this._shaderSets[7].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[7].shaderProgram,"a_texCoord"),this._shaderSets[7].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[7].shaderProgram,"s_texture0"),this._shaderSets[7].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[7].shaderProgram,"u_matrix"),this._shaderSets[7].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[7].shaderProgram,"u_baseColor"),this._shaderSets[8].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[8].shaderProgram,"a_position"),this._shaderSets[8].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[8].shaderProgram,"a_texCoord"),this._shaderSets[8].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[8].shaderProgram,"s_texture0"),this._shaderSets[8].samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets[8].shaderProgram,"s_texture1"),this._shaderSets[8].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[8].shaderProgram,"u_matrix"),this._shaderSets[8].uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets[8].shaderProgram,"u_clipMatrix"),this._shaderSets[8].uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets[8].shaderProgram,"u_channelFlag"),this._shaderSets[8].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[8].shaderProgram,"u_baseColor"),this._shaderSets[9].attributePositionLocation=this.gl.getAttribLocation(this._shaderSets[9].shaderProgram,"a_position"),this._shaderSets[9].attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets[9].shaderProgram,"a_texCoord"),this._shaderSets[9].samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets[9].shaderProgram,"s_texture0"),this._shaderSets[9].samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets[9].shaderProgram,"s_texture1"),this._shaderSets[9].uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets[9].shaderProgram,"u_matrix"),this._shaderSets[9].uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets[9].shaderProgram,"u_clipMatrix"),this._shaderSets[9].uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets[9].shaderProgram,"u_channelFlag"),this._shaderSets[9].uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets[9].shaderProgram,"u_baseColor")}loadShaderProgram(a,b){let c=this.gl.createProgram(),d=this.compileShaderSource(this.gl.VERTEX_SHADER,a);if(!d)return M("Vertex shader compile error!"),0;let e=this.compileShaderSource(this.gl.FRAGMENT_SHADER,b);return e?(this.gl.attachShader(c,d),this.gl.attachShader(c,e),this.gl.linkProgram(c),this.gl.getProgramParameter(c,this.gl.LINK_STATUS))?(this.gl.deleteShader(d),this.gl.deleteShader(e),c):(M("Failed to link program: {0}",c),this.gl.deleteShader(d),this.gl.deleteShader(e),c&&this.gl.deleteProgram(c),0):(M("Vertex shader compile error!"),0)}compileShaderSource(a,b){let c=this.gl.createShader(a);return(this.gl.shaderSource(c,b),this.gl.compileShader(c),c||M("Shader compile log: {0} ",this.gl.getShaderInfoLog(c)),this.gl.getShaderParameter(c,this.gl.COMPILE_STATUS))?c:(this.gl.deleteShader(c),null)}setGl(a){this.gl=a}}var aL=(a=>(a[a.ShaderNames_SetupMask=0]="ShaderNames_SetupMask",a[a.ShaderNames_NormalPremultipliedAlpha=1]="ShaderNames_NormalPremultipliedAlpha",a[a.ShaderNames_NormalMaskedPremultipliedAlpha=2]="ShaderNames_NormalMaskedPremultipliedAlpha",a[a.ShaderNames_NomralMaskedInvertedPremultipliedAlpha=3]="ShaderNames_NomralMaskedInvertedPremultipliedAlpha",a[a.ShaderNames_AddPremultipliedAlpha=4]="ShaderNames_AddPremultipliedAlpha",a[a.ShaderNames_AddMaskedPremultipliedAlpha=5]="ShaderNames_AddMaskedPremultipliedAlpha",a[a.ShaderNames_AddMaskedPremultipliedAlphaInverted=6]="ShaderNames_AddMaskedPremultipliedAlphaInverted",a[a.ShaderNames_MultPremultipliedAlpha=7]="ShaderNames_MultPremultipliedAlpha",a[a.ShaderNames_MultMaskedPremultipliedAlpha=8]="ShaderNames_MultMaskedPremultipliedAlpha",a[a.ShaderNames_MultMaskedPremultipliedAlphaInverted=9]="ShaderNames_MultMaskedPremultipliedAlphaInverted",a))(aL||{});let aM="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;varying vec4       v_myPos;uniform mat4       u_clipMatrix;void main(){   gl_Position = u_clipMatrix * a_position;   v_myPos = u_clipMatrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",aN="precision mediump float;varying vec2       v_texCoord;varying vec4       v_myPos;uniform vec4       u_baseColor;uniform vec4       u_channelFlag;uniform sampler2D  s_texture0;void main(){   float isInside =        step(u_baseColor.x, v_myPos.x/v_myPos.w)       * step(u_baseColor.y, v_myPos.y/v_myPos.w)       * step(v_myPos.x/v_myPos.w, u_baseColor.z)       * step(v_myPos.y/v_myPos.w, u_baseColor.w);   gl_FragColor = u_channelFlag * texture2D(s_texture0, v_texCoord).a * isInside;}",aO="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;uniform mat4       u_matrix;void main(){   gl_Position = u_matrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",aP="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;varying vec4       v_clipPos;uniform mat4       u_matrix;uniform mat4       u_clipMatrix;void main(){   gl_Position = u_matrix * a_position;   v_clipPos = u_clipMatrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",aQ="precision mediump float;varying vec2       v_texCoord;uniform vec4       u_baseColor;uniform sampler2D  s_texture0;void main(){   gl_FragColor = texture2D(s_texture0 , v_texCoord) * u_baseColor;}",aR="precision mediump float;varying vec2       v_texCoord;varying vec4       v_clipPos;uniform vec4       u_baseColor;uniform vec4       u_channelFlag;uniform sampler2D  s_texture0;uniform sampler2D  s_texture1;void main(){   vec4 col_formask = texture2D(s_texture0 , v_texCoord) * u_baseColor;   vec4 clipMask = (1.0 - texture2D(s_texture1, v_clipPos.xy / v_clipPos.w)) * u_channelFlag;   float maskVal = clipMask.r + clipMask.g + clipMask.b + clipMask.a;   col_formask = col_formask * maskVal;   gl_FragColor = col_formask;}",aS="precision mediump float;varying vec2 v_texCoord;varying vec4 v_clipPos;uniform sampler2D s_texture0;uniform sampler2D s_texture1;uniform vec4 u_channelFlag;uniform vec4 u_baseColor;void main(){vec4 col_formask = texture2D(s_texture0, v_texCoord) * u_baseColor;vec4 clipMask = (1.0 - texture2D(s_texture1, v_clipPos.xy / v_clipPos.w)) * u_channelFlag;float maskVal = clipMask.r + clipMask.g + clipMask.b + clipMask.a;col_formask = col_formask * (1.0 - maskVal);gl_FragColor = col_formask;}";class aT extends A{constructor(){super(),this._clippingContextBufferForMask=null,this._clippingContextBufferForDraw=null,this._clippingManager=new aH,this.firstDraw=!0,this._textures={},this._sortedDrawableIndexList=[],this._bufferData={vertex:null,uv:null,index:null}}initialize(a){a.isUsingMasking()&&(this._clippingManager=new aH,this._clippingManager.initialize(a,a.getDrawableCount(),a.getDrawableMasks(),a.getDrawableMaskCounts()));for(let b=a.getDrawableCount()-1;b>=0;b--)this._sortedDrawableIndexList[b]=0;super.initialize(a)}bindTexture(a,b){this._textures[a]=b}getBindedTextures(){return this._textures}setClippingMaskBufferSize(a){this._clippingManager.release(),this._clippingManager=new aH,this._clippingManager.setClippingMaskBufferSize(a),this._clippingManager.initialize(this.getModel(),this.getModel().getDrawableCount(),this.getModel().getDrawableMasks(),this.getModel().getDrawableMaskCounts())}getClippingMaskBufferSize(){return this._clippingManager.getClippingMaskBufferSize()}release(){var a,b,c;this._clippingManager.release(),this._clippingManager=void 0,null==(a=this.gl)||a.deleteBuffer(this._bufferData.vertex),this._bufferData.vertex=null,null==(b=this.gl)||b.deleteBuffer(this._bufferData.uv),this._bufferData.uv=null,null==(c=this.gl)||c.deleteBuffer(this._bufferData.index),this._bufferData.index=null,this._bufferData=void 0,this._textures=void 0}doDrawModel(){this.preDraw(),null!=this._clippingManager&&this._clippingManager.setupClippingContext(this.getModel(),this);let a=this.getModel().getDrawableCount(),b=this.getModel().getDrawableRenderOrders();for(let c=0;c<a;++c){let a=b[c];this._sortedDrawableIndexList[a]=c}for(let b=0;b<a;++b){let a=this._sortedDrawableIndexList[b];this.getModel().getDrawableDynamicFlagIsVisible(a)&&(this.setClippingContextBufferForDraw(null!=this._clippingManager?this._clippingManager.getClippingContextListForDraw()[a]:null),this.setIsCulling(this.getModel().getDrawableCulling(a)),this.drawMesh(this.getModel().getDrawableTextureIndices(a),this.getModel().getDrawableVertexIndexCount(a),this.getModel().getDrawableVertexCount(a),this.getModel().getDrawableVertexIndices(a),this.getModel().getDrawableVertices(a),this.getModel().getDrawableVertexUvs(a),this.getModel().getDrawableOpacity(a),this.getModel().getDrawableBlendMode(a),this.getModel().getDrawableInvertedMaskBit(a)))}}drawMesh(a,b,c,d,e,f,g,h,i){this.isCulling()?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this.gl.frontFace(this.gl.CCW);let j=this.getModelColor();null==this.getClippingContextBufferForMask()&&(j.A*=g,this.isPremultipliedAlpha()&&(j.R*=j.A,j.G*=j.A,j.B*=j.A));let k=null;null!=this._textures[a]&&(k=this._textures[a]),aK.getInstance().setupShaderProgram(this,k,c,e,d,f,this._bufferData,g,h,j,this.isPremultipliedAlpha(),this.getMvpMatrix(),i),this.gl.drawElements(this.gl.TRIANGLES,b,this.gl.UNSIGNED_SHORT,0),this.gl.useProgram(null),this.setClippingContextBufferForDraw(null),this.setClippingContextBufferForMask(null)}static doStaticRelease(){aK.deleteInstance()}setRenderState(a,b){f=a,e=b}preDraw(){this.firstDraw&&(this.firstDraw=!1,this._anisortopy=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.disable(this.gl.STENCIL_TEST),this.gl.disable(this.gl.DEPTH_TEST),this.gl.frontFace(this.gl.CW),this.gl.enable(this.gl.BLEND),this.gl.colorMask(!0,!0,!0,!0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null)}setClippingContextBufferForMask(a){this._clippingContextBufferForMask=a}getClippingContextBufferForMask(){return this._clippingContextBufferForMask}setClippingContextBufferForDraw(a){this._clippingContextBufferForDraw=a}getClippingContextBufferForDraw(){return this._clippingContextBufferForDraw}startUp(a){this.gl=a,this._clippingManager.setGL(a),aK.getInstance().setGl(a)}}A.staticRelease=()=>{aT.doStaticRelease()};class aU{constructor(a){this.groups=a.Groups,this.hitAreas=a.HitAreas,this.layout=a.Layout,this.moc=a.FileReferences.Moc,this.expressions=a.FileReferences.Expressions,this.motions=a.FileReferences.Motions,this.textures=a.FileReferences.Textures,this.physics=a.FileReferences.Physics,this.pose=a.FileReferences.Pose}getEyeBlinkParameters(){var a,b;return null==(b=null==(a=this.groups)?void 0:a.find(a=>"EyeBlink"===a.Name))?void 0:b.Ids}getLipSyncParameters(){var a,b;return null==(b=null==(a=this.groups)?void 0:a.find(a=>"LipSync"===a.Name))?void 0:b.Ids}}(a=>{a.LOG_LEVEL_VERBOSE=0,a.LOG_LEVEL_WARNING=1,a.LOG_LEVEL_ERROR=2,a.LOG_LEVEL_NONE=999,a.logLevel=a.LOG_LEVEL_WARNING,a.sound=!0,a.motionSync=!0,a.motionFadingDuration=500,a.idleMotionFadingDuration=2e3,a.expressionFadingDuration=500,a.preserveExpressionOnMotion=!0,a.cubism4=j})(k||(k={}));let aV={log(a,...b){k.logLevel<=k.LOG_LEVEL_VERBOSE&&console.log(`[${a}]`,...b)},warn(a,...b){k.logLevel<=k.LOG_LEVEL_WARNING&&console.warn(`[${a}]`,...b)},error(a,...b){k.logLevel<=k.LOG_LEVEL_ERROR&&console.error(`[${a}]`,...b)}};function aW(a,b){b.forEach(b=>{Object.getOwnPropertyNames(b.prototype).forEach(c=>{"constructor"!==c&&Object.defineProperty(a.prototype,c,Object.getOwnPropertyDescriptor(b.prototype,c))})})}class aX extends l.EventEmitter{constructor(a,b){super(),this.expressions=[],this.reserveExpressionIndex=-1,this.destroyed=!1,this.settings=a,this.tag=`ExpressionManager(${a.name})`}init(){this.defaultExpression=this.createExpression({},void 0),this.currentExpression=this.defaultExpression,this.stopAllExpressions()}loadExpression(a){return q(this,null,function*(){if(!this.definitions[a])return void aV.warn(this.tag,`Undefined expression at [${a}]`);if(null===this.expressions[a])return void aV.warn(this.tag,`Cannot set expression at [${a}] because it's already failed in loading.`);if(this.expressions[a])return this.expressions[a];let b=yield this._loadExpression(a);return this.expressions[a]=b,b})}_loadExpression(a){throw Error("Not implemented.")}setRandomExpression(){return q(this,null,function*(){if(this.definitions.length){let a=[];for(let b=0;b<this.definitions.length;b++)null!==this.expressions[b]&&this.expressions[b]!==this.currentExpression&&b!==this.reserveExpressionIndex&&a.push(b);if(a.length){let b=Math.floor(Math.random()*a.length);return this.setExpression(b)}}return!1})}resetExpression(){this._setExpression(this.defaultExpression)}restoreExpression(){this._setExpression(this.currentExpression)}setExpression(a){return q(this,null,function*(){if("number"!=typeof a&&(a=this.getExpressionIndex(a)),!(a>-1&&a<this.definitions.length)||a===this.expressions.indexOf(this.currentExpression))return!1;this.reserveExpressionIndex=a;let b=yield this.loadExpression(a);return!!b&&this.reserveExpressionIndex===a&&(this.reserveExpressionIndex=-1,this.currentExpression=b,this._setExpression(b),!0)})}update(a,b){return!this.isFinished()&&this.updateParameters(a,b)}destroy(){this.destroyed=!0,this.emit("destroy"),this.definitions=void 0,this.expressions=void 0}}let aY=40/7.5,aZ=1/150;class a${constructor(){this.targetX=0,this.targetY=0,this.x=0,this.y=0,this.vx=0,this.vy=0}focus(a,b,c=!1){this.targetX=a<-1?-1:a>1?1:a,this.targetY=b<-1?-1:b>1?1:b,c&&(this.x=this.targetX,this.y=this.targetY)}update(a){let b=this.targetX-this.x,c=this.targetY-this.y;if(.01>Math.abs(b)&&.01>Math.abs(c))return;let d=Math.sqrt(p(b,2)+p(c,2)),e=aY/(1e3/a),f=b/d*e-this.vx,g=c/d*e-this.vy,h=Math.sqrt(p(f,2)+p(g,2)),i=e*aZ*a;h>i&&(f*=i/h,g*=i/h),this.vx+=f,this.vy+=g;let j=Math.sqrt(p(this.vx,2)+p(this.vy,2)),k=.5*(Math.sqrt(p(i,2)+8*i*d)-i);j>k&&(this.vx*=k/j,this.vy*=k/j),this.x+=this.vx,this.y+=this.vy}}class a_{constructor(a){this.json=a;let b=a.url;if("string"!=typeof b)throw TypeError("The `url` field in settings JSON must be defined as a string.");this.url=b,this.name=function(a){let b=a.lastIndexOf("/");return -1!=b&&(a=a.slice(0,b)),-1!==(b=a.lastIndexOf("/"))&&(a=a.slice(b+1)),a}(this.url)}resolveURL(a){return l.url.resolve(this.url,a)}replaceFiles(a){this.moc=a(this.moc,"moc"),void 0!==this.pose&&(this.pose=a(this.pose,"pose")),void 0!==this.physics&&(this.physics=a(this.physics,"physics"));for(let b=0;b<this.textures.length;b++)this.textures[b]=a(this.textures[b],`textures[${b}]`)}getDefinedFiles(){let a=[];return this.replaceFiles(b=>(a.push(b),b)),a}validateFiles(a){let b=(b,c)=>{let d=this.resolveURL(b);if(!a.includes(d)){if(c)throw Error(`File "${b}" is defined in settings, but doesn't exist in given files`);return!1}return!0};return[this.moc,...this.textures].forEach(a=>b(a,!0)),this.getDefinedFiles().filter(a=>b(a,!1))}}var a0=(a=>(a[a.NONE=0]="NONE",a[a.IDLE=1]="IDLE",a[a.NORMAL=2]="NORMAL",a[a.FORCE=3]="FORCE",a))(a0||{});class a1{constructor(){this.debug=!1,this.currentPriority=0,this.reservePriority=0}reserve(a,b,c){if(c<=0)return aV.log(this.tag,"Cannot start a motion with MotionPriority.NONE."),!1;if(a===this.currentGroup&&b===this.currentIndex)return aV.log(this.tag,"Motion is already playing.",this.dump(a,b)),!1;if(a===this.reservedGroup&&b===this.reservedIndex||a===this.reservedIdleGroup&&b===this.reservedIdleIndex)return aV.log(this.tag,"Motion is already reserved.",this.dump(a,b)),!1;if(1===c){if(0!==this.currentPriority)return aV.log(this.tag,"Cannot start idle motion because another motion is playing.",this.dump(a,b)),!1;if(void 0!==this.reservedIdleGroup)return aV.log(this.tag,"Cannot start idle motion because another idle motion has reserved.",this.dump(a,b)),!1;this.setReservedIdle(a,b)}else{if(c<3){if(c<=this.currentPriority)return aV.log(this.tag,"Cannot start motion because another motion is playing as an equivalent or higher priority.",this.dump(a,b)),!1;if(c<=this.reservePriority)return aV.log(this.tag,"Cannot start motion because another motion has reserved as an equivalent or higher priority.",this.dump(a,b)),!1}this.setReserved(a,b,c)}return!0}start(a,b,c,d){if(1===d){if(this.setReservedIdle(void 0,void 0),0!==this.currentPriority)return aV.log(this.tag,"Cannot start idle motion because another motion is playing.",this.dump(b,c)),!1}else{if(b!==this.reservedGroup||c!==this.reservedIndex)return aV.log(this.tag,"Cannot start motion because another motion has taken the place.",this.dump(b,c)),!1;this.setReserved(void 0,void 0,0)}return!!a&&(this.setCurrent(b,c,d),!0)}complete(){this.setCurrent(void 0,void 0,0)}setCurrent(a,b,c){this.currentPriority=c,this.currentGroup=a,this.currentIndex=b}setReserved(a,b,c){this.reservePriority=c,this.reservedGroup=a,this.reservedIndex=b}setReservedIdle(a,b){this.reservedIdleGroup=a,this.reservedIdleIndex=b}isActive(a,b){return a===this.currentGroup&&b===this.currentIndex||a===this.reservedGroup&&b===this.reservedIndex||a===this.reservedIdleGroup&&b===this.reservedIdleIndex}reset(){this.setCurrent(void 0,void 0,0),this.setReserved(void 0,void 0,0),this.setReservedIdle(void 0,void 0)}shouldRequestIdleMotion(){return void 0===this.currentGroup&&void 0===this.reservedIdleGroup}shouldOverrideExpression(){return!k.preserveExpressionOnMotion&&this.currentPriority>1}dump(a,b){return this.debug?`
<Requested> group = "${a}", index = ${b}
`+["currentPriority","reservePriority","currentGroup","currentIndex","reservedGroup","reservedIndex","reservedIdleGroup","reservedIdleIndex"].map(a=>"["+a+"] "+this[a]).join("\n"):""}}class a2{static get volume(){return this._volume}static set volume(a){this._volume=(a>1?1:a<0?0:a)||0,this.audios.forEach(a=>a.volume=this._volume)}static add(a,b,c){let d=new Audio(a);return d.volume=this._volume,d.preload="auto",d.addEventListener("ended",()=>{this.dispose(d),null==b||b()}),d.addEventListener("error",b=>{this.dispose(d),aV.warn("SoundManager",`Error occurred on "${a}"`,b.error),null==c||c(b.error)}),this.audios.push(d),d}static play(a){return new Promise((b,c)=>{var d;null==(d=a.play())||d.catch(b=>{a.dispatchEvent(new ErrorEvent("error",{error:b})),c(b)}),a.readyState===a.HAVE_ENOUGH_DATA?b():a.addEventListener("canplaythrough",b)})}static dispose(a){a.pause(),a.removeAttribute("src");var b=this.audios;let c=b.indexOf(a);-1!==c&&b.splice(c,1)}static destroy(){for(let a=this.audios.length-1;a>=0;a--)this.dispose(this.audios[a])}}a2.audios=[],a2._volume=.5;var a3=(a=>(a.ALL="ALL",a.IDLE="IDLE",a.NONE="NONE",a))(a3||{});class a4 extends l.EventEmitter{constructor(a,b){super(),this.motionGroups={},this.state=new a1,this.playing=!1,this.destroyed=!1,this.settings=a,this.tag=`MotionManager(${a.name})`,this.state.tag=this.tag}init(a){(null==a?void 0:a.idleMotionGroup)&&(this.groups.idle=a.idleMotionGroup),this.setupMotions(a),this.stopAllMotions()}setupMotions(a){let b;for(let a of Object.keys(this.definitions))this.motionGroups[a]=[];switch(null==a?void 0:a.motionPreload){case"NONE":return;case"ALL":b=Object.keys(this.definitions);break;default:b=[this.groups.idle]}for(let a of b)if(this.definitions[a])for(let b=0;b<this.definitions[a].length;b++)this.loadMotion(a,b).then()}loadMotion(a,b){return q(this,null,function*(){var c;if(!(null==(c=this.definitions[a])?void 0:c[b]))return void aV.warn(this.tag,`Undefined motion at "${a}"[${b}]`);if(null===this.motionGroups[a][b])return void aV.warn(this.tag,`Cannot start motion at "${a}"[${b}] because it's already failed in loading.`);if(this.motionGroups[a][b])return this.motionGroups[a][b];let d=yield this._loadMotion(a,b);if(!this.destroyed)return this.motionGroups[a][b]=null!=d?d:null,d})}_loadMotion(a,b){throw Error("Not implemented.")}startMotion(a,b){return q(this,arguments,function*(a,b,c=a0.NORMAL){var d;let e;if(!this.state.reserve(a,b,c))return!1;let f=null==(d=this.definitions[a])?void 0:d[b];if(!f)return!1;if(this.currentAudio&&a2.dispose(this.currentAudio),k.sound){let a=this.getSoundFile(f);if(a)try{e=a2.add(this.settings.resolveURL(a),()=>this.currentAudio=void 0,()=>this.currentAudio=void 0),this.currentAudio=e}catch(b){aV.warn(this.tag,"Failed to create audio",a,b)}}let g=yield this.loadMotion(a,b);if(e){let a=a2.play(e).catch(a=>aV.warn(this.tag,"Failed to play audio",e.src,a));k.motionSync&&(yield a)}return this.state.start(g,a,b,c)?(aV.log(this.tag,"Start motion:",this.getMotionName(f)),this.emit("motionStart",a,b,e),this.state.shouldOverrideExpression()&&this.expressionManager&&this.expressionManager.resetExpression(),this.playing=!0,this._startMotion(g),!0):(e&&(a2.dispose(e),this.currentAudio=void 0),!1)})}startRandomMotion(a,b){return q(this,null,function*(){let c=this.definitions[a];if(null==c?void 0:c.length){let d=[];for(let b=0;b<c.length;b++)null===this.motionGroups[a][b]||this.state.isActive(a,b)||d.push(b);if(d.length){let c=Math.floor(Math.random()*d.length);return this.startMotion(a,d[c],b)}}return!1})}stopAllMotions(){this._stopAllMotions(),this.state.reset(),this.currentAudio&&(a2.dispose(this.currentAudio),this.currentAudio=void 0)}update(a,b){var c;return this.isFinished()&&(this.playing&&(this.playing=!1,this.emit("motionFinish")),this.state.shouldOverrideExpression()&&(null==(c=this.expressionManager)||c.restoreExpression()),this.state.complete(),this.state.shouldRequestIdleMotion()&&this.startRandomMotion(this.groups.idle,a0.IDLE)),this.updateParameters(a,b)}destroy(){var a;this.destroyed=!0,this.emit("destroy"),this.stopAllMotions(),null==(a=this.expressionManager)||a.destroy(),this.definitions=void 0,this.motionGroups=void 0}}let a5={x:0,y:0,width:0,height:0};class a6 extends l.EventEmitter{constructor(){super(...arguments),this.focusController=new a$,this.originalWidth=0,this.originalHeight=0,this.width=0,this.height=0,this.localTransform=new m.uq,this.drawingMatrix=new m.uq,this.hitAreas={},this.textureFlipY=!1,this.viewport=[0,0,0,0],this.destroyed=!1}init(){this.setupLayout(),this.setupHitAreas()}setupLayout(){let a=this.getSize();this.originalWidth=a[0],this.originalHeight=a[1];let b=Object.assign({width:2,height:2},this.getLayout());this.localTransform.scale(b.width/2,b.height/2),this.width=this.originalWidth*this.localTransform.a,this.height=this.originalHeight*this.localTransform.d;let c=void 0!==b.x&&b.x-b.width/2||void 0!==b.centerX&&b.centerX||void 0!==b.left&&b.left-b.width/2||void 0!==b.right&&b.right+b.width/2||0,d=void 0!==b.y&&b.y-b.height/2||void 0!==b.centerY&&b.centerY||void 0!==b.top&&b.top-b.height/2||void 0!==b.bottom&&b.bottom+b.height/2||0;this.localTransform.translate(this.width*c,-this.height*d)}setupHitAreas(){for(let a of this.getHitAreaDefs().filter(a=>a.index>=0))this.hitAreas[a.name]=a}hitTest(a,b){return Object.keys(this.hitAreas).filter(c=>this.isHit(c,a,b))}isHit(a,b,c){if(!this.hitAreas[a])return!1;let d=this.hitAreas[a].index,e=this.getDrawableBounds(d,a5);return e.x<=b&&b<=e.x+e.width&&e.y<=c&&c<=e.y+e.height}getDrawableBounds(a,b){let c=this.getDrawableVertices(a),d=c[0],e=c[0],f=c[1],g=c[1];for(let a=0;a<c.length;a+=2){let b=c[a],h=c[a+1];d=Math.min(b,d),e=Math.max(b,e),f=Math.min(h,f),g=Math.max(h,g)}return null!=b||(b={}),b.x=d,b.y=f,b.width=e-d,b.height=g-f,b}updateTransform(a){this.drawingMatrix.copyFrom(a).append(this.localTransform)}update(a,b){this.focusController.update(a)}destroy(){this.destroyed=!0,this.emit("destroy"),this.motionManager.destroy(),this.motionManager=void 0}}class a7 extends Error{constructor(a,b,c,d=!1){super(a),this.url=b,this.status=c,this.aborted=d}}let a8=class{static createXHR(a,b,c,d,e){let f=new XMLHttpRequest;if(a8.allXhrSet.add(f),a){let b=a8.xhrMap.get(a);b?b.add(f):(b=new Set([f]),a8.xhrMap.set(a,b)),a.listeners("destroy").includes(a8.cancelXHRs)||a.once("destroy",a8.cancelXHRs)}return f.open("GET",b),f.responseType=c,f.onload=()=>{(200===f.status||0===f.status)&&f.response?d(f.response):f.onerror()},f.onerror=()=>{aV.warn("XHRLoader",`Failed to load resource as ${f.responseType} (Status ${f.status}): ${b}`),e(new a7("Network error.",b,f.status))},f.onabort=()=>e(new a7("Aborted.",b,f.status,!0)),f.onloadend=()=>{var b;a8.allXhrSet.delete(f),a&&(null==(b=a8.xhrMap.get(a))||b.delete(f))},f}static cancelXHRs(){var a;null==(a=a8.xhrMap.get(this))||a.forEach(a=>{a.abort(),a8.allXhrSet.delete(a)}),a8.xhrMap.delete(this)}static release(){a8.allXhrSet.forEach(a=>a.abort()),a8.allXhrSet.clear(),a8.xhrMap=new WeakMap}};function a9(a,b){let c=-1;return function d(e,f){if(f)return Promise.reject(f);if(e<=c)return Promise.reject(Error("next() called multiple times"));c=e;let g=a[e];if(!g)return Promise.resolve();try{return Promise.resolve(g(b,d.bind(null,e+1)))}catch(a){return Promise.reject(a)}}(0)}a8.xhrMap=new WeakMap,a8.allXhrSet=new Set,a8.loader=(a,b)=>new Promise((b,c)=>{a8.createXHR(a.target,a.settings?a.settings.resolveURL(a.url):a.url,a.type,c=>{a.result=c,b()},c).send()});class ba{static load(a){return a9(this.middlewares,a).then(()=>a.result)}}ba.middlewares=[a8.loader];let bb="Live2DFactory",bc=(a,b)=>q(void 0,null,function*(){if("string"==typeof a.source){let b=yield ba.load({url:a.source,type:"json",target:a.live2dModel});b.url=a.source,a.source=b,a.live2dModel.emit("settingsJSONLoaded",b)}return b()}),bd=(a,b)=>q(void 0,null,function*(){if(a.source instanceof a_)return a.settings=a.source,b();if("object"==typeof a.source){let c=bj.findRuntime(a.source);if(c){let d=c.createModelSettings(a.source);return a.settings=d,a.live2dModel.emit("settingsLoaded",d),b()}}throw TypeError("Unknown settings format.")}),be=(a,b)=>{if(a.settings){let c=bj.findRuntime(a.settings);if(c)return c.ready().then(b)}return b()},bf=(a,b)=>q(void 0,null,function*(){yield b();let c=a.internalModel;if(c){let b=a.settings,d=bj.findRuntime(b);if(d){let e=[];b.pose&&e.push(ba.load({settings:b,url:b.pose,type:"json",target:c}).then(b=>{c.pose=d.createPose(c.coreModel,b),a.live2dModel.emit("poseLoaded",c.pose)}).catch(b=>{a.live2dModel.emit("poseLoadError",b),aV.warn(bb,"Failed to load pose.",b)})),b.physics&&e.push(ba.load({settings:b,url:b.physics,type:"json",target:c}).then(b=>{c.physics=d.createPhysics(c.coreModel,b),a.live2dModel.emit("physicsLoaded",c.physics)}).catch(b=>{a.live2dModel.emit("physicsLoadError",b),aV.warn(bb,"Failed to load physics.",b)})),e.length&&(yield Promise.all(e))}}}),bg=(a,b)=>q(void 0,null,function*(){if(a.settings){let c=a.live2dModel,d=a.settings.textures.map(b=>(function(a,b={}){let c={resourceOptions:{crossorigin:b.crossOrigin}};if(n.gP.fromURL)return n.gP.fromURL(a,c).catch(a=>{if(a instanceof Error)throw a;let b=Error("Texture loading error");throw b.event=a,b});c.resourceOptions.autoLoad=!1;let d=n.gP.from(a,c);if(d.baseTexture.valid)return Promise.resolve(d);let e=d.baseTexture.resource;return null!=e._live2d_load||(e._live2d_load=new Promise((a,b)=>{let c=a=>{e.source.removeEventListener("error",c);let d=Error("Texture loading error");d.event=a,b(d)};e.source.addEventListener("error",c),e.load().then(()=>a(d)).catch(c)})),e._live2d_load})(a.settings.resolveURL(b),{crossOrigin:a.options.crossOrigin}));if(yield b(),a.internalModel)c.internalModel=a.internalModel,c.emit("modelLoaded",a.internalModel);else throw TypeError("Missing internal model.");c.textures=yield Promise.all(d),c.emit("textureLoaded",c.textures)}else throw TypeError("Missing settings.")}),bh=(a,b)=>q(void 0,null,function*(){let c=a.settings;if(c instanceof a_){let d=bj.findRuntime(c);if(!d)throw TypeError("Unknown model settings.");let e=yield ba.load({settings:c,url:c.moc,type:"arraybuffer",target:a.live2dModel});if(!d.isValidMoc(e))throw Error("Invalid moc data");let f=d.createCoreModel(e);return a.internalModel=d.createInternalModel(f,c,a.options),b()}throw TypeError("Missing settings.")}),bi=class{static registerRuntime(a){bi.runtimes.push(a),bi.runtimes.sort((a,b)=>b.version-a.version)}static findRuntime(a){for(let b of bi.runtimes)if(b.test(a))return b}static setupLive2DModel(a,b,c){return q(this,null,function*(){let d=Promise.all([new Promise(b=>a.once("textureLoaded",b)),new Promise(b=>a.once("modelLoaded",b))]).then(()=>a.emit("ready"));yield a9(bi.live2DModelMiddlewares,{live2dModel:a,source:b,options:c||{}}),yield d,a.emit("load")})}static loadMotion(a,b,c){var d;let e=d=>a.emit("motionLoadError",b,c,d);try{let f=null==(d=a.definitions[b])?void 0:d[c];if(!f)return Promise.resolve(void 0);a.listeners("destroy").includes(bi.releaseTasks)||a.once("destroy",bi.releaseTasks);let g=bi.motionTasksMap.get(a);g||(g={},bi.motionTasksMap.set(a,g));let h=g[b];h||(h=[],g[b]=h);let i=a.getMotionFile(f);return null!=h[c]||(h[c]=ba.load({url:i,settings:a.settings,type:a.motionDataType,target:a}).then(d=>{var e;let g=null==(e=bi.motionTasksMap.get(a))?void 0:e[b];g&&delete g[c];let h=a.createMotion(d,b,f);return a.emit("motionLoaded",b,c,h),h}).catch(b=>{aV.warn(a.tag,`Failed to load motion: ${i}
`,b),e(b)})),h[c]}catch(d){aV.warn(a.tag,`Failed to load motion at "${b}"[${c}]
`,d),e(d)}return Promise.resolve(void 0)}static loadExpression(a,b){let c=c=>a.emit("expressionLoadError",b,c);try{let d=a.definitions[b];if(!d)return Promise.resolve(void 0);a.listeners("destroy").includes(bi.releaseTasks)||a.once("destroy",bi.releaseTasks);let e=bi.expressionTasksMap.get(a);e||(e=[],bi.expressionTasksMap.set(a,e));let f=a.getExpressionFile(d);return null!=e[b]||(e[b]=ba.load({url:f,settings:a.settings,type:"json",target:a}).then(c=>{let e=bi.expressionTasksMap.get(a);e&&delete e[b];let f=a.createExpression(c,d);return a.emit("expressionLoaded",b,f),f}).catch(b=>{aV.warn(a.tag,`Failed to load expression: ${f}
`,b),c(b)})),e[b]}catch(d){aV.warn(a.tag,`Failed to load expression at [${b}]
`,d),c(d)}return Promise.resolve(void 0)}static releaseTasks(){this instanceof a4?bi.motionTasksMap.delete(this):bi.expressionTasksMap.delete(this)}},bj=bi;bj.runtimes=[],bj.urlToJSON=bc,bj.jsonToSettings=bd,bj.waitUntilReady=be,bj.setupOptionals=bf,bj.setupEssentials=bg,bj.createInternalModel=bh,bj.live2DModelMiddlewares=[bc,bd,be,bf,bg,bh],bj.motionTasksMap=new WeakMap,bj.expressionTasksMap=new WeakMap,a4.prototype._loadMotion=function(a,b){return bj.loadMotion(this,a,b)},aX.prototype._loadExpression=function(a){return bj.loadExpression(this,a)};class bk{constructor(){this._autoInteract=!1}get autoInteract(){return this._autoInteract}set autoInteract(a){a!==this._autoInteract&&(a?this.on("pointertap",bl,this):this.off("pointertap",bl,this),this._autoInteract=a)}registerInteraction(a){a!==this.interactionManager&&(this.unregisterInteraction(),this._autoInteract&&a&&(this.interactionManager=a,a.on("pointermove",bm,this)))}unregisterInteraction(){var a;this.interactionManager&&(null==(a=this.interactionManager)||a.off("pointermove",bm,this),this.interactionManager=void 0)}}function bl(a){this.tap(a.data.global.x,a.data.global.y)}function bm(a){this.focus(a.data.global.x,a.data.global.y)}class bn extends m.dL{}let bo=new m.bR,bp=new m.uq;class bq extends o.mc{constructor(a){super(),this.tag="Live2DModel(uninitialized)",this.textures=[],this.transform=new bn,this.anchor=new m.oA(this.onAnchorChange,this,0,0),this.glContextID=-1,this.elapsedTime=performance.now(),this.deltaTime=0,this._autoUpdate=!1,this.once("modelLoaded",()=>this.init(a))}static from(a,b){let c=new this(b);return bj.setupLive2DModel(c,a,b).then(()=>c)}static fromSync(a,b){let c=new this(b);return bj.setupLive2DModel(c,a,b).then(null==b?void 0:b.onLoad).catch(null==b?void 0:b.onError),c}static registerTicker(a){g=a}get autoUpdate(){return this._autoUpdate}set autoUpdate(a){var b;g||(g=null==(b=window.PIXI)?void 0:b.Ticker),a?this._destroyed||(g?(g.shared.add(this.onTickerUpdate,this),this._autoUpdate=!0):aV.warn(this.tag,"No Ticker registered, please call Live2DModel.registerTicker(Ticker).")):(null==g||g.shared.remove(this.onTickerUpdate,this),this._autoUpdate=!1)}init(a){this.tag=`Live2DModel(${this.internalModel.settings.name})`;let b=Object.assign({autoUpdate:!0,autoInteract:!0},a);b.autoInteract&&(this.interactive=!0),this.autoInteract=b.autoInteract,this.autoUpdate=b.autoUpdate}onAnchorChange(){this.pivot.set(this.anchor.x*this.internalModel.width,this.anchor.y*this.internalModel.height)}motion(a,b,c){return void 0===b?this.internalModel.motionManager.startRandomMotion(a,c):this.internalModel.motionManager.startMotion(a,b,c)}expression(a){return this.internalModel.motionManager.expressionManager?void 0===a?this.internalModel.motionManager.expressionManager.setRandomExpression():this.internalModel.motionManager.expressionManager.setExpression(a):Promise.resolve(!1)}focus(a,b,c=!1){bo.x=a,bo.y=b,this.toModelPosition(bo,bo,!0);let d=bo.x/this.internalModel.originalWidth*2-1,e=Math.atan2(bo.y/this.internalModel.originalHeight*2-1,d);this.internalModel.focusController.focus(Math.cos(e),-Math.sin(e),c)}tap(a,b){let c=this.hitTest(a,b);c.length&&(aV.log(this.tag,"Hit",c),this.emit("hit",c))}hitTest(a,b){return bo.x=a,bo.y=b,this.toModelPosition(bo,bo),this.internalModel.hitTest(bo.x,bo.y)}toModelPosition(a,b=a.clone(),c){return c||(this._recursivePostUpdateTransform(),this.parent?this.displayObjectUpdateTransform():(this.parent=this._tempDisplayObjectParent,this.displayObjectUpdateTransform(),this.parent=null)),this.transform.worldTransform.applyInverse(a,b),this.internalModel.localTransform.applyInverse(b,b),b}containsPoint(a){return this.getBounds(!0).contains(a.x,a.y)}_calculateBounds(){this._bounds.addFrame(this.transform,0,0,this.internalModel.width,this.internalModel.height)}onTickerUpdate(){this.update(g.shared.deltaMS)}update(a){this.deltaTime+=a,this.elapsedTime+=a}_render(a){this.registerInteraction(a.plugins.interaction),a.batch.reset(),a.geometry.reset(),a.shader.reset(),a.state.reset();let b=!1;this.glContextID!==a.CONTEXT_UID&&(this.glContextID=a.CONTEXT_UID,this.internalModel.updateWebGLContext(a.gl,this.glContextID),b=!0);for(let c=0;c<this.textures.length;c++){let d=this.textures[c];d.valid&&((b||!d.baseTexture._glTextures[this.glContextID])&&(a.gl.pixelStorei(WebGLRenderingContext.UNPACK_FLIP_Y_WEBGL,this.internalModel.textureFlipY),a.texture.bind(d.baseTexture,0)),this.internalModel.bindTexture(c,d.baseTexture._glTextures[this.glContextID].texture),d.baseTexture.touched=a.textureGC.count)}let c=a.framebuffer.viewport;this.internalModel.viewport=[c.x,c.y,c.width,c.height],this.deltaTime&&(this.internalModel.update(this.deltaTime,this.elapsedTime),this.deltaTime=0);let d=bp.copyFrom(a.globalUniforms.uniforms.projectionMatrix).append(this.worldTransform);this.internalModel.updateTransform(d),this.internalModel.draw(a.gl),a.state.reset(),a.texture.reset()}destroy(a){this.emit("destroy"),this.autoUpdate=!1,this.unregisterInteraction(),(null==a?void 0:a.texture)&&this.textures.forEach(b=>b.destroy(a.baseTexture)),this.internalModel.destroy(),super.destroy(a)}}aW(bq,[bk]);let br=class{static resolveURL(a,b){var c;let d=null==(c=br.filesMap[a])?void 0:c[b];if(void 0===d)throw Error("Cannot find this file from uploaded files: "+b);return d}static upload(a,b){return q(this,null,function*(){let c={};for(let d of b.getDefinedFiles()){let e=decodeURI(l.url.resolve(b.url,d)),f=a.find(a=>a.webkitRelativePath===e);f&&(c[d]=URL.createObjectURL(f))}br.filesMap[b._objectURL]=c})}static createSettings(a){return q(this,null,function*(){let b=a.find(a=>a.name.endsWith("model.json")||a.name.endsWith("model3.json"));if(!b)throw TypeError("Settings file not found");let c=JSON.parse((yield br.readText(b)));c.url=b.webkitRelativePath;let d=bj.findRuntime(c);if(!d)throw Error("Unknown settings JSON");let e=d.createModelSettings(c);return e._objectURL=URL.createObjectURL(b),e})}static readText(a){return q(this,null,function*(){return new Promise((b,c)=>{let d=new FileReader;d.onload=()=>b(d.result),d.onerror=c,d.readAsText(a,"utf8")})})}};br.filesMap={},br.factory=(a,b)=>q(void 0,null,function*(){if(Array.isArray(a.source)&&a.source[0]instanceof File){let b=a.source,c=b.settings;if(c){if(!c._objectURL)throw Error('"_objectURL" must be specified in ModelSettings')}else c=yield br.createSettings(b);c.validateFiles(b.map(a=>encodeURI(a.webkitRelativePath))),yield br.upload(b,c),c.resolveURL=function(a){return br.resolveURL(this._objectURL,a)},a.source=c,a.live2dModel.once("modelLoaded",a=>{a.once("destroy",function(){let a=this.settings._objectURL;if(URL.revokeObjectURL(a),br.filesMap[a])for(let b of Object.values(br.filesMap[a]))URL.revokeObjectURL(b);delete br.filesMap[a]})})}return b()}),bj.live2DModelMiddlewares.unshift(br.factory);let bs=class{static unzip(a,b){return q(this,null,function*(){let c=yield bs.getFilePaths(a),d=[];for(let a of b.getDefinedFiles()){let e=decodeURI(l.url.resolve(b.url,a));c.includes(e)&&d.push(e)}let e=yield bs.getFiles(a,d);for(let a=0;a<e.length;a++){let b=d[a];Object.defineProperty(e[a],"webkitRelativePath",{value:b})}return e})}static createSettings(a){return q(this,null,function*(){let b=(yield bs.getFilePaths(a)).find(a=>a.endsWith("model.json")||a.endsWith("model3.json"));if(!b)throw Error("Settings file not found");let c=yield bs.readText(a,b);if(!c)throw Error("Empty settings file: "+b);let d=JSON.parse(c);d.url=b;let e=bj.findRuntime(d);if(!e)throw Error("Unknown settings JSON");return e.createModelSettings(d)})}static zipReader(a,b){return q(this,null,function*(){throw Error("Not implemented")})}static getFilePaths(a){return q(this,null,function*(){throw Error("Not implemented")})}static getFiles(a,b){return q(this,null,function*(){throw Error("Not implemented")})}static readText(a,b){return q(this,null,function*(){throw Error("Not implemented")})}static releaseReader(a){}};if(bs.ZIP_PROTOCOL="zip://",bs.uid=0,bs.factory=(a,b)=>q(void 0,null,function*(){let c,d,e,f=a.source;if("string"==typeof f&&(f.endsWith(".zip")||f.startsWith(bs.ZIP_PROTOCOL))?(c=f.startsWith(bs.ZIP_PROTOCOL)?f.slice(bs.ZIP_PROTOCOL.length):f,d=yield ba.load({url:c,type:"blob",target:a.live2dModel})):Array.isArray(f)&&1===f.length&&f[0]instanceof File&&f[0].name.endsWith(".zip")&&(d=f[0],c=URL.createObjectURL(d),e=f.settings),d){if(!d.size)throw Error("Empty zip file");let b=yield bs.zipReader(d,c);e||(e=yield bs.createSettings(b)),e._objectURL=bs.ZIP_PROTOCOL+bs.uid+"/"+e.url;let f=yield bs.unzip(b,e);f.settings=e,a.source=f,c.startsWith("blob:")&&a.live2dModel.once("modelLoaded",a=>{a.once("destroy",function(){URL.revokeObjectURL(c)})}),bs.releaseReader(b)}return b()}),bj.live2DModelMiddlewares.unshift(bs.factory),!window.Live2DCubismCore)throw Error("Could not find Cubism 4 runtime. This plugin requires live2dcubismcore.js to be loaded.");class bt extends aX{constructor(a,b){var c;super(a,b),this.queueManager=new aj,this.definitions=null!=(c=a.expressions)?c:[],this.init()}isFinished(){return this.queueManager.isFinished()}getExpressionIndex(a){return this.definitions.findIndex(b=>b.Name===a)}getExpressionFile(a){return a.File}createExpression(a,b){return R.create(a)}_setExpression(a){return this.queueManager.startMotion(a,!1,performance.now())}stopAllExpressions(){this.queueManager.stopAllMotions()}updateParameters(a,b){return this.queueManager.doUpdateMotion(a,b)}}class bu extends a_{constructor(a){if(super(a),!bu.isValidJSON(a))throw TypeError("Invalid JSON.");Object.assign(this,new aU(a))}static isValidJSON(a){var b;return!!(null==a?void 0:a.FileReferences)&&"string"==typeof a.FileReferences.Moc&&(null==(b=a.FileReferences.Textures)?void 0:b.length)>0&&a.FileReferences.Textures.every(a=>"string"==typeof a)}replaceFiles(a){if(super.replaceFiles(a),this.motions)for(let[b,c]of Object.entries(this.motions))for(let d=0;d<c.length;d++)c[d].File=a(c[d].File,`motions.${b}[${d}].File`),void 0!==c[d].Sound&&(c[d].Sound=a(c[d].Sound,`motions.${b}[${d}].Sound`));if(this.expressions)for(let b=0;b<this.expressions.length;b++)this.expressions[b].File=a(this.expressions[b].File,`expressions[${b}].File`)}}aW(bu,[aU]);class bv extends a4{constructor(a,b){var c;super(a,b),this.groups={idle:"Idle"},this.motionDataType="json",this.queueManager=new aj,this.definitions=null!=(c=a.motions)?c:{},this.eyeBlinkIds=a.getEyeBlinkParameters()||[],this.lipSyncIds=a.getLipSyncParameters()||[],this.init(b)}init(a){super.init(a),this.settings.expressions&&(this.expressionManager=new bt(this.settings,a)),this.queueManager.setEventCallback((a,b,c)=>{this.emit("motion:"+b)})}isFinished(){return this.queueManager.isFinished()}_startMotion(a,b){return a.setFinishedMotionHandler(b),this.queueManager.stopAllMotions(),this.queueManager.startMotion(a,!1,performance.now())}_stopAllMotions(){this.queueManager.stopAllMotions()}createMotion(a,b,c){let d=ah.create(a),e=new $(a),f=(b===this.groups.idle?k.idleMotionFadingDuration:k.motionFadingDuration)/1e3;return void 0===e.getMotionFadeInTime()&&d.setFadeInTime(c.FadeInTime>0?c.FadeInTime:f),void 0===e.getMotionFadeOutTime()&&d.setFadeOutTime(c.FadeOutTime>0?c.FadeOutTime:f),d.setEffectIds(this.eyeBlinkIds,this.lipSyncIds),d}getMotionFile(a){return a.File}getMotionName(a){return a.File}getSoundFile(a){return a.Sound}updateParameters(a,b){return this.queueManager.doUpdateMotion(a,b)}destroy(){super.destroy(),this.queueManager.release(),this.queueManager=void 0}}let bw=new z;class bx extends a6{constructor(a,b,c){super(),this.lipSync=!0,this.breath=r.create(),this.renderer=new aT,this.idParamAngleX="ParamAngleX",this.idParamAngleY="ParamAngleY",this.idParamAngleZ="ParamAngleZ",this.idParamEyeBallX="ParamEyeBallX",this.idParamEyeBallY="ParamEyeBallY",this.idParamBodyAngleX="ParamBodyAngleX",this.idParamBreath="ParamBreath",this.pixelsPerUnit=1,this.centeringTransform=new m.uq,this.coreModel=a,this.settings=b,this.motionManager=new bv(b,c),this.init()}init(){var a;super.init(),(null==(a=this.settings.getEyeBlinkParameters())?void 0:a.length)>0&&(this.eyeBlink=t.create(this.settings)),this.breath.setParameters([new s(this.idParamAngleX,0,15,6.5345,.5),new s(this.idParamAngleY,0,8,3.5345,.5),new s(this.idParamAngleZ,0,10,5.5345,.5),new s(this.idParamBodyAngleX,0,4,15.5345,.5),new s(this.idParamBreath,0,.5,3.2345,.5)]),this.renderer.initialize(this.coreModel),this.renderer.setIsPremultipliedAlpha(!0)}getSize(){return[this.coreModel.getModel().canvasinfo.CanvasWidth,this.coreModel.getModel().canvasinfo.CanvasHeight]}getLayout(){let a={};if(this.settings.layout)for(let b of Object.keys(this.settings.layout))a[b.charAt(0).toLowerCase()+b.slice(1)]=this.settings.layout[b];return a}setupLayout(){super.setupLayout(),this.pixelsPerUnit=this.coreModel.getModel().canvasinfo.PixelsPerUnit,this.centeringTransform.scale(this.pixelsPerUnit,this.pixelsPerUnit).translate(this.originalWidth/2,this.originalHeight/2)}updateWebGLContext(a,b){this.renderer.firstDraw=!0,this.renderer._bufferData={vertex:null,uv:null,index:null},this.renderer.startUp(a),this.renderer._clippingManager._currentFrameNo=b,this.renderer._clippingManager._maskTexture=void 0,aK.getInstance()._shaderSets=[]}bindTexture(a,b){this.renderer.bindTexture(a,b)}getHitAreaDefs(){var a,b;return null!=(b=null==(a=this.settings.hitAreas)?void 0:a.map(a=>({id:a.Id,name:a.Name,index:this.coreModel.getDrawableIndex(a.Id)})))?b:[]}getDrawableIDs(){return this.coreModel.getDrawableIds()}getDrawableIndex(a){return this.coreModel.getDrawableIndex(a)}getDrawableVertices(a){if("string"==typeof a&&-1===(a=this.coreModel.getDrawableIndex(a)))throw TypeError("Unable to find drawable ID: "+a);let b=this.coreModel.getDrawableVertices(a).slice();for(let a=0;a<b.length;a+=2)b[a]=b[a]*this.pixelsPerUnit+this.originalWidth/2,b[a+1]=-b[a+1]*this.pixelsPerUnit+this.originalHeight/2;return b}updateTransform(a){this.drawingMatrix.copyFrom(this.centeringTransform).prepend(this.localTransform).prepend(a)}update(a,b){var c,d,e,f;super.update(a,b),a/=1e3,b/=1e3;let g=this.coreModel;this.emit("beforeMotionUpdate");let h=this.motionManager.update(this.coreModel,b);this.emit("afterMotionUpdate"),g.saveParameters(),null==(c=this.motionManager.expressionManager)||c.update(g,b),h||null==(d=this.eyeBlink)||d.updateParameters(g,a),this.updateFocus(),this.updateNaturalMovements(1e3*a,1e3*b),null==(e=this.physics)||e.evaluate(g,a),null==(f=this.pose)||f.updateParameters(g,a),this.emit("beforeModelUpdate"),g.update(),g.loadParameters()}updateFocus(){this.coreModel.addParameterValueById(this.idParamEyeBallX,this.focusController.x),this.coreModel.addParameterValueById(this.idParamEyeBallY,this.focusController.y),this.coreModel.addParameterValueById(this.idParamAngleX,30*this.focusController.x),this.coreModel.addParameterValueById(this.idParamAngleY,30*this.focusController.y),this.coreModel.addParameterValueById(this.idParamAngleZ,-(this.focusController.x*this.focusController.y*30)),this.coreModel.addParameterValueById(this.idParamBodyAngleX,10*this.focusController.x)}updateNaturalMovements(a,b){var c;null==(c=this.breath)||c.updateParameters(this.coreModel,a/1e3)}draw(a){let b=this.drawingMatrix,c=bw.getArray();c[0]=b.a,c[1]=b.b,c[4]=-b.c,c[5]=-b.d,c[12]=b.tx,c[13]=b.ty,this.renderer.setMvpMatrix(bw),this.renderer.setRenderState(a.getParameter(a.FRAMEBUFFER_BINDING),this.viewport),this.renderer.drawModel()}destroy(){super.destroy(),this.renderer.release(),this.coreModel.release(),this.renderer=void 0,this.coreModel=void 0}}let by=20;function bz(){var a;null==(a=this.__moc)||a.release()}bj.registerRuntime({version:4,ready:function(){return G.isStarted()?Promise.resolve():(null!=h||(h=new Promise((a,b)=>{!function c(){try{var d;d=Object.assign({logFunction:console.log,loggingLevel:H.LogLevel_Verbose},d),G.startUp(d),G.initialize(),a()}catch(a){if(--by<0){let c=Error("Failed to start up Cubism 4 framework.");c.cause=a,b(c);return}aV.log("Cubism4","Startup failed, retrying 10ms later..."),setTimeout(c,10)}}()})),h)},test:a=>a instanceof bu||bu.isValidJSON(a),isValidMoc:a=>!(a.byteLength<4)&&"MOC3"===String.fromCharCode(...new Int8Array(a,0,4)),createModelSettings:a=>new bu(a),createCoreModel(a){let b=P.create(a);try{let a=b.createModel();return a.__moc=b,a}catch(a){try{b.release()}catch(a){}throw a}},createInternalModel(a,b,c){let d=new bx(a,b,c);return a.__moc&&(d.__moc=a.__moc,delete a.__moc,d.once("destroy",bz)),d},createPhysics:(a,b)=>au.create(b),createPose:(a,b)=>v.create(b)})}};